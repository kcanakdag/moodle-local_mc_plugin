define("local_mc_plugin/connect",["jquery"],(function($){var pollTimer=null,pollAttempts=0,currentToken=null;function stopPolling(){pollTimer&&(clearInterval(pollTimer),pollTimer=null)}return{init:function(config){return{startConnection:function(){!function(config){stopPolling(),pollAttempts=0,config.onStatusChange("initializing",M.util.get_string("connect_initializing","local_mc_plugin")),$.ajax({url:config.connectUrl,method:"POST",data:{action:"init",sesskey:config.sesskey},dataType:"json"}).done((function(response){if(response.success&&response.token){currentToken=response.token;var connectPageUrl=config.apiUrl.replace(/\/api\/?$/,"")+"/connect?token="+encodeURIComponent(response.token);if(!window.open(connectPageUrl,"_blank"))return void config.onError(M.util.get_string("connect_popup_blocked","local_mc_plugin"));config.onStatusChange("waiting",M.util.get_string("connect_waiting","local_mc_plugin")),function(config){pollTimer=setInterval((function(){if(++pollAttempts>60)return stopPolling(),void config.onError(M.util.get_string("connect_timeout","local_mc_plugin"));$.ajax({url:config.apiUrl+"/connect/status",method:"GET",data:{token:currentToken},dataType:"json"}).done((function(response){"completed"===response.status?(stopPolling(),response.site_key&&response.site_secret?function(config,siteKey,siteSecret){config.onStatusChange("saving",M.util.get_string("connect_saving","local_mc_plugin")),$.ajax({url:config.saveUrl,method:"POST",data:{action:"save",sesskey:config.sesskey,siteKey:siteKey,siteSecret:siteSecret},dataType:"json"}).done((function(response){response.success?config.onSuccess(siteKey):config.onError(response.message||M.util.get_string("connect_save_failed","local_mc_plugin"))})).fail((function(xhr,status,error){config.onError(M.util.get_string("connect_save_failed","local_mc_plugin")+": "+error)}))}(config,response.site_key,response.site_secret):config.onError(M.util.get_string("connect_credentials_retrieved","local_mc_plugin"))):"expired"===response.status?(stopPolling(),config.onError(M.util.get_string("connect_token_expired","local_mc_plugin"))):"pending"===response.status&&config.onStatusChange("waiting",M.util.get_string("connect_waiting","local_mc_plugin"))})).fail((function(){}))}),3e3)}(config)}else config.onError(response.message||M.util.get_string("connect_init_failed","local_mc_plugin"))})).fail((function(xhr,status,error){config.onError(M.util.get_string("connect_init_failed","local_mc_plugin")+": "+error)}))}(config)},stopPolling:stopPolling}}}}));

//# sourceMappingURL=connect.min.js.map