define("local_mc_plugin/connect",["exports","./local/admin/repository","./local/admin/connection_status","core/str"],(function(_exports,Repository,ConnectionStatus,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * MoodleConnect OAuth-style connection flow.
   *
   * This module handles:
   * - Opening the MoodleConnect tab with connection token
   * - Polling for connection completion
   * - Storing credentials on success
   *
   * @module     local_mc_plugin/connect
   * @copyright  2025 Kerem Can Akdag
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,Repository=_interopRequireWildcard(Repository),ConnectionStatus=_interopRequireWildcard(ConnectionStatus);let config={},strings={},pollTimer=null,pollAttempts=0,currentToken=null,isConnected=!1;const getElements=()=>({connectBtn:document.getElementById("mc-connect-btn"),btnText:document.getElementById("mc-connect-btn-text"),btnSpinner:document.getElementById("mc-connect-btn-spinner"),statusDiv:document.getElementById("mc-connect-status"),statusIcon:document.getElementById("mc-connect-status-icon"),statusText:document.getElementById("mc-connect-status-text")}),showStatus=(type,message)=>{const{statusDiv:statusDiv,statusIcon:statusIcon,statusText:statusText}=getElements();statusDiv&&(statusDiv.style.display="block","waiting"===type?(statusDiv.style.background="#fff3cd",statusDiv.style.color="#856404",statusIcon.innerHTML='<span class="spinner-border spinner-border-sm" style="margin-right: 8px;"></span>'):"success"===type?(statusDiv.style.background="#d4edda",statusDiv.style.color="#155724",statusIcon.innerHTML="✓ "):"error"===type&&(statusDiv.style.background="#f8d7da",statusDiv.style.color="#721c24",statusIcon.innerHTML="✗ "),statusText.textContent=message)},setLoading=loading=>{const{connectBtn:connectBtn,btnSpinner:btnSpinner}=getElements();connectBtn&&(connectBtn.disabled=loading),btnSpinner&&(btnSpinner.style.display=loading?"inline-block":"none")},setBtnText=text=>{const{btnText:btnText}=getElements();btnText&&(btnText.textContent=text)},stopPolling=()=>{pollTimer&&(clearInterval(pollTimer),pollTimer=null)},pollStatus=async()=>{if(pollAttempts++,pollAttempts>60)return stopPolling(),setLoading(!1),void showStatus("error",strings.timeout);try{const data=await Repository.pollConnectionStatus(config.apiUrl,currentToken);"completed"===data.status?(stopPolling(),data.site_key&&data.site_secret?(async(siteKey,siteSecret)=>{showStatus("waiting",strings.saving);try{const data=await Repository.saveCredentials(config.saveUrl,config.sesskey,siteKey,siteSecret);if(setLoading(!1),data.success){showStatus("success",strings.success),setBtnText(strings.reconnectBtn);const{connectBtn:connectBtn}=getElements();connectBtn&&(connectBtn.classList.remove("btn-primary"),connectBtn.classList.add("btn-outline-primary")),isConnected=!0,setTimeout((()=>{ConnectionStatus.testConnection()}),500)}else showStatus("error",data.message||strings.saveFailed)}catch(err){setLoading(!1),showStatus("error","".concat(strings.saveFailed,": ").concat(err.message))}})(data.site_key,data.site_secret):(setLoading(!1),showStatus("error",strings.credentialsRetrieved))):"expired"===data.status&&(stopPolling(),setLoading(!1),showStatus("error",strings.tokenExpired))}catch{}},startConnection=async()=>{(()=>{const{statusDiv:statusDiv}=getElements();statusDiv&&(statusDiv.style.display="none")})(),setLoading(!0),setBtnText(strings.initializing),pollAttempts=0;try{const data=await Repository.initConnection(config.connectUrl,config.sesskey);if(data.success&&data.token){currentToken=data.token;const connectPageUrl="".concat(config.frontendUrl,"/connect?token=").concat(encodeURIComponent(data.token));if(!window.open(connectPageUrl,"_blank"))return setLoading(!1),setBtnText(isConnected?strings.reconnectBtn:strings.connectBtn),void showStatus("error",strings.popupBlocked);setBtnText(strings.waitingBtn),showStatus("waiting",strings.waiting),pollTimer=setInterval(pollStatus,3e3)}else setLoading(!1),setBtnText(isConnected?strings.reconnectBtn:strings.connectBtn),showStatus("error",data.message||strings.initFailed)}catch(err){setLoading(!1),setBtnText(isConnected?strings.reconnectBtn:strings.connectBtn),showStatus("error","".concat(strings.initFailed,": ").concat(err.message))}};_exports.init=async cfg=>{config=cfg,isConnected=cfg.isConnected||!1,await(async()=>{const results=await(0,_str.get_strings)([{key:"connect_initializing",component:"local_mc_plugin"},{key:"connect_waiting",component:"local_mc_plugin"},{key:"connect_waiting_btn",component:"local_mc_plugin"},{key:"connect_saving",component:"local_mc_plugin"},{key:"connect_success",component:"local_mc_plugin"},{key:"connect_popup_blocked",component:"local_mc_plugin"},{key:"connect_init_failed",component:"local_mc_plugin"},{key:"connect_timeout",component:"local_mc_plugin"},{key:"connect_token_expired",component:"local_mc_plugin"},{key:"connect_credentials_retrieved",component:"local_mc_plugin"},{key:"connect_save_failed",component:"local_mc_plugin"},{key:"connect_button",component:"local_mc_plugin"},{key:"reconnect_button",component:"local_mc_plugin"}]);strings={initializing:results[0],waiting:results[1],waitingBtn:results[2],saving:results[3],success:results[4],popupBlocked:results[5],initFailed:results[6],timeout:results[7],tokenExpired:results[8],credentialsRetrieved:results[9],saveFailed:results[10],connectBtn:results[11],reconnectBtn:results[12]}})();const{connectBtn:connectBtn}=getElements();connectBtn&&connectBtn.addEventListener("click",startConnection)}}));

//# sourceMappingURL=connect.min.js.map