define(["jquery"],function(n){var t=null,e=0,i=null;function o(){t&&(clearInterval(t),t=null)}return{init:function(c){return{startConnection:function(){!function(c){o(),e=0,c.onStatusChange("initializing",M.util.get_string("connect_initializing","local_mc_plugin")),n.ajax({url:c.connectUrl,method:"POST",data:{action:"init",sesskey:c.sesskey},dataType:"json"}).done(function(l){if(l.success&&l.token){i=l.token;var a=c.apiUrl.replace(/\/api\/?$/,"")+"/connect?token="+encodeURIComponent(l.token);if(!window.open(a,"_blank"))return void c.onError(M.util.get_string("connect_popup_blocked","local_mc_plugin"));c.onStatusChange("waiting",M.util.get_string("connect_waiting","local_mc_plugin")),function(c){t=setInterval(function(){if(++e>60)return o(),void c.onError(M.util.get_string("connect_timeout","local_mc_plugin"));n.ajax({url:c.apiUrl+"/connect/status",method:"GET",data:{token:i},dataType:"json"}).done(function(t){"completed"===t.status?(o(),t.site_key&&t.site_secret?function(t,e,i){t.onStatusChange("saving",M.util.get_string("connect_saving","local_mc_plugin")),n.ajax({url:t.saveUrl,method:"POST",data:{action:"save",sesskey:t.sesskey,siteKey:e,siteSecret:i},dataType:"json"}).done(function(n){n.success?t.onSuccess(e):t.onError(n.message||M.util.get_string("connect_save_failed","local_mc_plugin"))}).fail(function(n,e,i){t.onError(M.util.get_string("connect_save_failed","local_mc_plugin")+": "+i)})}(c,t.site_key,t.site_secret):c.onError(M.util.get_string("connect_credentials_retrieved","local_mc_plugin"))):"expired"===t.status?(o(),c.onError(M.util.get_string("connect_token_expired","local_mc_plugin"))):"pending"===t.status&&c.onStatusChange("waiting",M.util.get_string("connect_waiting","local_mc_plugin"))}).fail(function(){})},3e3)}(c)}else c.onError(l.message||M.util.get_string("connect_init_failed","local_mc_plugin"))}).fail(function(n,t,e){c.onError(M.util.get_string("connect_init_failed","local_mc_plugin")+": "+e)})}(c)},stopPolling:o}}}});
//# sourceMappingURL=connect.min.js.map