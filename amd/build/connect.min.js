/**
 * MoodleConnect OAuth-style connection flow.
 *
 * This module handles:
 * - Opening the MoodleConnect tab with connection token
 * - Polling for connection completion
 * - Storing credentials on success
 *
 * Uses data-* attributes from connect_button.mustache template.
 *
 * @module     local_mc_plugin/connect
 * @copyright  2025 Kerem Can Akdag
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["local_mc_plugin/local/admin/selectors","local_mc_plugin/local/admin/repository","local_mc_plugin/local/admin/connection_status","core/str"],function(e,n,t,c){"use strict";let o={},l={},s=null,i=0,a=null,r=!1,u=null,d=null,p=null,m=null,_=null,y=null;const g=(e,n)=>{m&&(m.classList.remove("d-none"),m.style.display="block",m.classList.remove("alert-warning","alert-success","alert-danger"),"waiting"===e?(m.classList.add("alert-warning"),_&&(_.innerHTML='<span class="spinner-border spinner-border-sm mr-2"></span>')):"success"===e?(m.classList.add("alert-success"),_&&(_.innerHTML="✓ ")):"error"===e&&(m.classList.add("alert-danger"),_&&(_.innerHTML="✗ ")),y&&(y.textContent=n))},k=e=>{u&&(u.disabled=e),p&&(e?p.classList.remove("d-none"):p.classList.add("d-none"))},v=e=>{d&&(d.textContent=e)},S=()=>{s&&(clearInterval(s),s=null)},w=async()=>{if(i++,i>60)return S(),k(!1),void g("error",l.timeout);try{const e=await n.pollConnectionStatus(o.apiUrl,a);"completed"===e.status?(S(),e.site_key&&e.site_secret?(async(e,c)=>{g("waiting",l.saving);try{const s=await n.saveCredentials(o.saveUrl,o.sesskey,e,c);k(!1),s.success?(g("success",l.success),v(l.reconnectBtn),u&&(u.classList.remove("btn-primary"),u.classList.add("btn-outline-primary")),r=!0,setTimeout(()=>{t.testConnection()},500)):g("error",s.message||l.saveFailed)}catch(e){k(!1),g("error",`${l.saveFailed}: ${e.message}`)}})(e.site_key,e.site_secret):(k(!1),g("error",l.credentialsRetrieved))):"expired"===e.status&&(S(),k(!1),g("error",l.tokenExpired))}catch(e){}},b=()=>{k(!1),v(r?l.reconnectBtn:l.connectBtn)},L=async()=>{m&&(m.classList.add("d-none"),m.style.display="none"),k(!0),v(l.initializing),i=0;try{const e=await n.initConnection(o.connectUrl,o.sesskey);e.success&&e.token?(e=>{a=e.token;const n=`${o.frontendUrl}/connect?token=${encodeURIComponent(e.token)}`;if(!window.open(n,"_blank"))return b(),void g("error",l.popupBlocked);v(l.waitingBtn),g("waiting",l.waiting),s=setInterval(w,3e3)})(e):(b(),g("error",e.message||l.initFailed))}catch(e){b(),g("error",`${l.initFailed}: ${e.message}`)}},B=(e,n,t)=>u&&u.dataset[e]?u.dataset[e]:t&&t[n]?t[n]:"";return{init:async function(n){n=n||null,await(async()=>{const e=await c.get_strings([{key:"connect_initializing",component:"local_mc_plugin"},{key:"connect_waiting",component:"local_mc_plugin"},{key:"connect_waiting_btn",component:"local_mc_plugin"},{key:"connect_saving",component:"local_mc_plugin"},{key:"connect_success",component:"local_mc_plugin"},{key:"connect_popup_blocked",component:"local_mc_plugin"},{key:"connect_init_failed",component:"local_mc_plugin"},{key:"connect_timeout",component:"local_mc_plugin"},{key:"connect_token_expired",component:"local_mc_plugin"},{key:"connect_credentials_retrieved",component:"local_mc_plugin"},{key:"connect_save_failed",component:"local_mc_plugin"},{key:"connect_button",component:"local_mc_plugin"},{key:"reconnect_button",component:"local_mc_plugin"}]);l={initializing:e[0],waiting:e[1],waitingBtn:e[2],saving:e[3],success:e[4],popupBlocked:e[5],initFailed:e[6],timeout:e[7],tokenExpired:e[8],credentialsRetrieved:e[9],saveFailed:e[10],connectBtn:e[11],reconnectBtn:e[12]}})(),(()=>{const n=document.querySelector(e.connect.container);n?(u=n.querySelector(e.connect.button),d=n.querySelector(e.connect.buttonText),p=n.querySelector(e.connect.buttonSpinner),m=n.querySelector(e.connect.statusDiv),_=n.querySelector(e.connect.statusIcon),y=n.querySelector(e.connect.statusText)):(u=document.querySelector(e.connect.legacyButton),d=document.querySelector(e.connect.legacyButtonText),p=document.querySelector(e.connect.legacyButtonSpinner),m=document.querySelector(e.connect.legacyStatusDiv),_=document.querySelector(e.connect.legacyStatusIcon),y=document.querySelector(e.connect.legacyStatusText))})(),o=(e=>({connectUrl:B("connecturl","connectUrl",e),saveUrl:B("saveurl","saveUrl",e),apiUrl:B("apiurl","apiUrl",e),frontendUrl:B("frontendurl","frontendUrl",e),sesskey:B("sesskey","sesskey",e)}))(n),u?(r=u.classList.contains("btn-outline-primary")||Boolean(n&&n.isConnected),u.addEventListener("click",L)):n&&(r=Boolean(n.isConnected))}}});