define("local_mc_plugin/connect",["exports","./local/admin/selectors","./local/admin/repository","./local/admin/connection_status","core/str"],(function(_exports,_selectors,Repository,ConnectionStatus,_str){var obj;
/**
   * MoodleConnect OAuth-style connection flow.
   *
   * This module handles:
   * - Opening the MoodleConnect tab with connection token
   * - Polling for connection completion
   * - Storing credentials on success
   *
   * Uses data-* attributes from connect_button.mustache template.
   *
   * @module     local_mc_plugin/connect
   * @copyright  2025 Kerem Can Akdag
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_selectors=(obj=_selectors)&&obj.__esModule?obj:{default:obj},Repository=_interopRequireWildcard(Repository),ConnectionStatus=_interopRequireWildcard(ConnectionStatus);let config={},strings={},pollTimer=null,pollAttempts=0,currentToken=null,isConnected=!1,connectBtn=null,btnText=null,btnSpinner=null,statusDiv=null,statusIcon=null,statusText=null;const loadStrings=async()=>{const results=await(0,_str.get_strings)([{key:"connect_initializing",component:"local_mc_plugin"},{key:"connect_waiting",component:"local_mc_plugin"},{key:"connect_waiting_btn",component:"local_mc_plugin"},{key:"connect_saving",component:"local_mc_plugin"},{key:"connect_success",component:"local_mc_plugin"},{key:"connect_popup_blocked",component:"local_mc_plugin"},{key:"connect_init_failed",component:"local_mc_plugin"},{key:"connect_timeout",component:"local_mc_plugin"},{key:"connect_token_expired",component:"local_mc_plugin"},{key:"connect_credentials_retrieved",component:"local_mc_plugin"},{key:"connect_save_failed",component:"local_mc_plugin"},{key:"connect_button",component:"local_mc_plugin"},{key:"reconnect_button",component:"local_mc_plugin"}]);strings={initializing:results[0],waiting:results[1],waitingBtn:results[2],saving:results[3],success:results[4],popupBlocked:results[5],initFailed:results[6],timeout:results[7],tokenExpired:results[8],credentialsRetrieved:results[9],saveFailed:results[10],connectBtn:results[11],reconnectBtn:results[12]}},findElements=()=>{const container=document.querySelector(_selectors.default.connect.container);container?(connectBtn=container.querySelector(_selectors.default.connect.button),btnText=container.querySelector(_selectors.default.connect.buttonText),btnSpinner=container.querySelector(_selectors.default.connect.buttonSpinner),statusDiv=container.querySelector(_selectors.default.connect.statusDiv),statusIcon=container.querySelector(_selectors.default.connect.statusIcon),statusText=container.querySelector(_selectors.default.connect.statusText)):(connectBtn=document.querySelector(_selectors.default.connect.legacyButton),btnText=document.querySelector(_selectors.default.connect.legacyButtonText),btnSpinner=document.querySelector(_selectors.default.connect.legacyButtonSpinner),statusDiv=document.querySelector(_selectors.default.connect.legacyStatusDiv),statusIcon=document.querySelector(_selectors.default.connect.legacyStatusIcon),statusText=document.querySelector(_selectors.default.connect.legacyStatusText))},showStatus=(type,message)=>{statusDiv&&(statusDiv.classList.remove("d-none"),statusDiv.style.display="block",statusDiv.classList.remove("alert-warning","alert-success","alert-danger"),"waiting"===type?(statusDiv.classList.add("alert-warning"),statusIcon&&(statusIcon.innerHTML='<span class="spinner-border spinner-border-sm mr-2"></span>')):"success"===type?(statusDiv.classList.add("alert-success"),statusIcon&&(statusIcon.innerHTML="✓ ")):"error"===type&&(statusDiv.classList.add("alert-danger"),statusIcon&&(statusIcon.innerHTML="✗ ")),statusText&&(statusText.textContent=message))},setLoading=loading=>{connectBtn&&(connectBtn.disabled=loading),btnSpinner&&(loading?btnSpinner.classList.remove("d-none"):btnSpinner.classList.add("d-none"))},setBtnText=text=>{btnText&&(btnText.textContent=text)},stopPolling=()=>{pollTimer&&(clearInterval(pollTimer),pollTimer=null)},pollStatus=async()=>{if(pollAttempts++,pollAttempts>60)return stopPolling(),setLoading(!1),void showStatus("error",strings.timeout);try{const data=await Repository.pollConnectionStatus(config.apiUrl,currentToken);"completed"===data.status?(stopPolling(),data.site_key&&data.site_secret?(async(siteKey,siteSecret)=>{showStatus("waiting",strings.saving);try{const data=await Repository.saveCredentials(config.saveUrl,config.sesskey,siteKey,siteSecret);setLoading(!1),data.success?(showStatus("success",strings.success),setBtnText(strings.reconnectBtn),connectBtn&&(connectBtn.classList.remove("btn-primary"),connectBtn.classList.add("btn-outline-primary")),isConnected=!0,setTimeout((()=>{ConnectionStatus.testConnection()}),500)):showStatus("error",data.message||strings.saveFailed)}catch(err){setLoading(!1),showStatus("error","".concat(strings.saveFailed,": ").concat(err.message))}})(data.site_key,data.site_secret):(setLoading(!1),showStatus("error",strings.credentialsRetrieved))):"expired"===data.status&&(stopPolling(),setLoading(!1),showStatus("error",strings.tokenExpired))}catch{}},resetButtonState=()=>{setLoading(!1),setBtnText(isConnected?strings.reconnectBtn:strings.connectBtn)},startConnection=async()=>{statusDiv&&(statusDiv.classList.add("d-none"),statusDiv.style.display="none"),setLoading(!0),setBtnText(strings.initializing),pollAttempts=0;try{const data=await Repository.initConnection(config.connectUrl,config.sesskey);data.success&&data.token?(data=>{currentToken=data.token;const connectPageUrl="".concat(config.frontendUrl,"/connect?token=").concat(encodeURIComponent(data.token));if(!window.open(connectPageUrl,"_blank"))return resetButtonState(),void showStatus("error",strings.popupBlocked);setBtnText(strings.waitingBtn),showStatus("waiting",strings.waiting),pollTimer=setInterval(pollStatus,3e3)})(data):(resetButtonState(),showStatus("error",data.message||strings.initFailed))}catch(err){resetButtonState(),showStatus("error","".concat(strings.initFailed,": ").concat(err.message))}},getConfigValue=(dataAttr,cfgKey,cfg)=>connectBtn&&connectBtn.dataset[dataAttr]?connectBtn.dataset[dataAttr]:cfg&&cfg[cfgKey]?cfg[cfgKey]:"",buildConfig=cfg=>({connectUrl:getConfigValue("connecturl","connectUrl",cfg),saveUrl:getConfigValue("saveurl","saveUrl",cfg),apiUrl:getConfigValue("apiurl","apiUrl",cfg),frontendUrl:getConfigValue("frontendurl","frontendUrl",cfg),sesskey:getConfigValue("sesskey","sesskey",cfg)});_exports.init=async function(){let cfg=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;await loadStrings(),findElements(),config=buildConfig(cfg),connectBtn?(isConnected=connectBtn.classList.contains("btn-outline-primary")||Boolean(cfg&&cfg.isConnected),connectBtn.addEventListener("click",startConnection)):cfg&&(isConnected=Boolean(cfg.isConnected))}}));

//# sourceMappingURL=connect.min.js.map