{"version":3,"names":["define","Selectors","Repository","ConnectionStatus","Str","config","strings","pollTimer","pollAttempts","currentToken","isConnected","connectBtn","btnText","btnSpinner","statusDiv","statusIcon","statusText","showStatus","type","message","classList","remove","style","display","add","innerHTML","textContent","setLoading","loading","disabled","setBtnText","text","stopPolling","clearInterval","pollStatus","async","timeout","data","pollConnectionStatus","apiUrl","status","site_key","site_secret","siteKey","siteSecret","saving","saveCredentials","saveUrl","sesskey","success","reconnectBtn","setTimeout","testConnection","saveFailed","err","credentialsRetrieved","tokenExpired","e","resetButtonState","startConnection","initializing","initConnection","connectUrl","token","connectPageUrl","frontendUrl","encodeURIComponent","window","open","popupBlocked","waitingBtn","waiting","setInterval","handleTokenSuccess","initFailed","getConfigValue","dataAttr","cfgKey","cfg","dataset","init","results","get_strings","key","component","loadStrings","container","document","querySelector","connect","button","buttonText","buttonSpinner","legacyButton","legacyButtonText","legacyButtonSpinner","legacyStatusDiv","legacyStatusIcon","legacyStatusText","findElements","buildConfig","contains","Boolean","addEventListener"],"sources":["amd/src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n *\n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n *\n * Uses data-* attributes from connect_button.mustache template.\n *\n * @module     local_mc_plugin/connect\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'local_mc_plugin/local/admin/selectors',\n    'local_mc_plugin/local/admin/repository',\n    'local_mc_plugin/local/admin/connection_status',\n    'core/str'\n], function(Selectors, Repository, ConnectionStatus, Str) {\n    \"use strict\";\n\n    const POLL_INTERVAL = 3000; // 3 seconds\n    const MAX_POLL_ATTEMPTS = 60; // 3 minutes total\n\n    /** @type {Object} Configuration */\n    let config = {};\n\n    /** @type {Object} Language strings */\n    let strings = {};\n\n    /** @type {number|null} Poll timer ID */\n    let pollTimer = null;\n\n    /** @type {number} Poll attempt counter */\n    let pollAttempts = 0;\n\n    /** @type {string|null} Current connection token */\n    let currentToken = null;\n\n    /** @type {boolean} Whether currently connected */\n    let isConnected = false;\n\n    /** @type {HTMLElement|null} Connect button */\n    let connectBtn = null;\n\n    /** @type {HTMLElement|null} Button text element */\n    let btnText = null;\n\n    /** @type {HTMLElement|null} Button spinner element */\n    let btnSpinner = null;\n\n    /** @type {HTMLElement|null} Status div element */\n    let statusDiv = null;\n\n    /** @type {HTMLElement|null} Status icon element */\n    let statusIcon = null;\n\n    /** @type {HTMLElement|null} Status text element */\n    let statusText = null;\n\n\n    /**\n     * Load language strings.\n     *\n     * @returns {Promise<void>}\n     */\n    const loadStrings = async() => {\n        const results = await Str.get_strings([\n            {key: 'connect_initializing', component: 'local_mc_plugin'},\n            {key: 'connect_waiting', component: 'local_mc_plugin'},\n            {key: 'connect_waiting_btn', component: 'local_mc_plugin'},\n            {key: 'connect_saving', component: 'local_mc_plugin'},\n            {key: 'connect_success', component: 'local_mc_plugin'},\n            {key: 'connect_popup_blocked', component: 'local_mc_plugin'},\n            {key: 'connect_init_failed', component: 'local_mc_plugin'},\n            {key: 'connect_timeout', component: 'local_mc_plugin'},\n            {key: 'connect_token_expired', component: 'local_mc_plugin'},\n            {key: 'connect_credentials_retrieved', component: 'local_mc_plugin'},\n            {key: 'connect_save_failed', component: 'local_mc_plugin'},\n            {key: 'connect_button', component: 'local_mc_plugin'},\n            {key: 'reconnect_button', component: 'local_mc_plugin'},\n        ]);\n\n        strings = {\n            initializing: results[0],\n            waiting: results[1],\n            waitingBtn: results[2],\n            saving: results[3],\n            success: results[4],\n            popupBlocked: results[5],\n            initFailed: results[6],\n            timeout: results[7],\n            tokenExpired: results[8],\n            credentialsRetrieved: results[9],\n            saveFailed: results[10],\n            connectBtn: results[11],\n            reconnectBtn: results[12],\n        };\n    };\n\n    /**\n     * Find DOM elements using data-* attribute selectors.\n     */\n    const findElements = () => {\n        // Try data-* attribute selectors first (from template)\n        const container = document.querySelector(Selectors.connect.container);\n\n        if (container) {\n            connectBtn = container.querySelector(Selectors.connect.button);\n            btnText = container.querySelector(Selectors.connect.buttonText);\n            btnSpinner = container.querySelector(Selectors.connect.buttonSpinner);\n            statusDiv = container.querySelector(Selectors.connect.statusDiv);\n            statusIcon = container.querySelector(Selectors.connect.statusIcon);\n            statusText = container.querySelector(Selectors.connect.statusText);\n        } else {\n            // Fallback to legacy ID-based selectors\n            connectBtn = document.querySelector(Selectors.connect.legacyButton);\n            btnText = document.querySelector(Selectors.connect.legacyButtonText);\n            btnSpinner = document.querySelector(Selectors.connect.legacyButtonSpinner);\n            statusDiv = document.querySelector(Selectors.connect.legacyStatusDiv);\n            statusIcon = document.querySelector(Selectors.connect.legacyStatusIcon);\n            statusText = document.querySelector(Selectors.connect.legacyStatusText);\n        }\n    };\n\n    /**\n     * Show status message.\n     *\n     * @param {string} type Status type: 'waiting', 'success', 'error'\n     * @param {string} message Status message\n     */\n    const showStatus = (type, message) => {\n        if (!statusDiv) {\n            return;\n        }\n\n        // Show the status div\n        statusDiv.classList.remove('d-none');\n        statusDiv.style.display = 'block';\n\n        // Remove previous alert classes\n        statusDiv.classList.remove('alert-warning', 'alert-success', 'alert-danger');\n\n        if (type === 'waiting') {\n            statusDiv.classList.add('alert-warning');\n            if (statusIcon) {\n                statusIcon.innerHTML = '<span class=\"spinner-border spinner-border-sm mr-2\"></span>';\n            }\n        } else if (type === 'success') {\n            statusDiv.classList.add('alert-success');\n            if (statusIcon) {\n                statusIcon.innerHTML = '✓ ';\n            }\n        } else if (type === 'error') {\n            statusDiv.classList.add('alert-danger');\n            if (statusIcon) {\n                statusIcon.innerHTML = '✗ ';\n            }\n        }\n\n        if (statusText) {\n            statusText.textContent = message;\n        }\n    };\n\n    /**\n     * Hide status message.\n     */\n    const hideStatus = () => {\n        if (statusDiv) {\n            statusDiv.classList.add('d-none');\n            statusDiv.style.display = 'none';\n        }\n    };\n\n    /**\n     * Set loading state.\n     *\n     * @param {boolean} loading Whether loading\n     */\n    const setLoading = (loading) => {\n        if (connectBtn) {\n            connectBtn.disabled = loading;\n        }\n        if (btnSpinner) {\n            if (loading) {\n                btnSpinner.classList.remove('d-none');\n            } else {\n                btnSpinner.classList.add('d-none');\n            }\n        }\n    };\n\n    /**\n     * Set button text.\n     *\n     * @param {string} text Button text\n     */\n    const setBtnText = (text) => {\n        if (btnText) {\n            btnText.textContent = text;\n        }\n    };\n\n    /**\n     * Stop polling.\n     */\n    const stopPolling = () => {\n        if (pollTimer) {\n            clearInterval(pollTimer);\n            pollTimer = null;\n        }\n    };\n\n    /**\n     * Save credentials after successful connection.\n     *\n     * @param {string} siteKey Site key\n     * @param {string} siteSecret Site secret\n     */\n    const saveCredentials = async(siteKey, siteSecret) => {\n        showStatus('waiting', strings.saving);\n\n        try {\n            const data = await Repository.saveCredentials(config.saveUrl, config.sesskey, siteKey, siteSecret);\n\n            setLoading(false);\n\n            if (data.success) {\n                showStatus('success', strings.success);\n                setBtnText(strings.reconnectBtn);\n\n                if (connectBtn) {\n                    connectBtn.classList.remove('btn-primary');\n                    connectBtn.classList.add('btn-outline-primary');\n                }\n\n                isConnected = true;\n\n                // Refresh connection status\n                setTimeout(() => {\n                    ConnectionStatus.testConnection();\n                }, 500);\n            } else {\n                showStatus('error', data.message || strings.saveFailed);\n            }\n        } catch (err) {\n            setLoading(false);\n            showStatus('error', `${strings.saveFailed}: ${err.message}`);\n        }\n    };\n\n    /**\n     * Poll for connection status.\n     */\n    const pollStatus = async() => {\n        pollAttempts++;\n\n        if (pollAttempts > MAX_POLL_ATTEMPTS) {\n            stopPolling();\n            setLoading(false);\n            showStatus('error', strings.timeout);\n            return;\n        }\n\n        try {\n            const data = await Repository.pollConnectionStatus(config.apiUrl, currentToken);\n\n            if (data.status === 'completed') {\n                stopPolling();\n\n                if (data.site_key && data.site_secret) {\n                    saveCredentials(data.site_key, data.site_secret);\n                } else {\n                    setLoading(false);\n                    showStatus('error', strings.credentialsRetrieved);\n                }\n            } else if (data.status === 'expired') {\n                stopPolling();\n                setLoading(false);\n                showStatus('error', strings.tokenExpired);\n            }\n            // If pending, continue polling\n        } catch (e) {\n            // Network error, but continue polling silently\n        }\n    };\n\n    /**\n     * Get the appropriate button text based on connection state.\n     *\n     * @returns {string} Button text\n     */\n    const getButtonText = () => {\n        return isConnected ? strings.reconnectBtn : strings.connectBtn;\n    };\n\n    /**\n     * Reset button state after connection attempt.\n     */\n    const resetButtonState = () => {\n        setLoading(false);\n        setBtnText(getButtonText());\n    };\n\n    /**\n     * Handle successful token retrieval and open connection window.\n     *\n     * @param {Object} data Response data with token\n     */\n    const handleTokenSuccess = (data) => {\n        currentToken = data.token;\n\n        // Open MoodleConnect in a new tab.\n        const connectPageUrl = `${config.frontendUrl}/connect?token=${encodeURIComponent(data.token)}`;\n        const connectWindow = window.open(connectPageUrl, '_blank');\n\n        if (!connectWindow) {\n            resetButtonState();\n            showStatus('error', strings.popupBlocked);\n            return;\n        }\n\n        setBtnText(strings.waitingBtn);\n        showStatus('waiting', strings.waiting);\n\n        // Start polling.\n        pollTimer = setInterval(pollStatus, POLL_INTERVAL);\n    };\n\n    /**\n     * Start the connection flow.\n     */\n    const startConnection = async() => {\n        hideStatus();\n        setLoading(true);\n        setBtnText(strings.initializing);\n        pollAttempts = 0;\n\n        try {\n            const data = await Repository.initConnection(config.connectUrl, config.sesskey);\n\n            if (data.success && data.token) {\n                handleTokenSuccess(data);\n            } else {\n                resetButtonState();\n                showStatus('error', data.message || strings.initFailed);\n            }\n        } catch (err) {\n            resetButtonState();\n            showStatus('error', `${strings.initFailed}: ${err.message}`);\n        }\n    };\n\n    /**\n     * Get config value from button data attribute or fallback config.\n     *\n     * @param {string} dataAttr Data attribute name (lowercase)\n     * @param {string} cfgKey Config key name\n     * @param {Object|null} cfg Fallback config object\n     * @returns {string} Config value\n     */\n    const getConfigValue = (dataAttr, cfgKey, cfg) => {\n        if (connectBtn && connectBtn.dataset[dataAttr]) {\n            return connectBtn.dataset[dataAttr];\n        }\n        if (cfg && cfg[cfgKey]) {\n            return cfg[cfgKey];\n        }\n        return '';\n    };\n\n    /**\n     * Build configuration from button data attributes or fallback config.\n     *\n     * @param {Object|null} cfg Fallback config object\n     * @returns {Object} Configuration object\n     */\n    const buildConfig = (cfg) => {\n        return {\n            connectUrl: getConfigValue('connecturl', 'connectUrl', cfg),\n            saveUrl: getConfigValue('saveurl', 'saveUrl', cfg),\n            apiUrl: getConfigValue('apiurl', 'apiUrl', cfg),\n            frontendUrl: getConfigValue('frontendurl', 'frontendUrl', cfg),\n            sesskey: getConfigValue('sesskey', 'sesskey', cfg),\n        };\n    };\n\n    return {\n        /**\n         * Initialize the connect module.\n         *\n         * @param {Object} [cfg] Optional configuration object\n         */\n        init: async function(cfg) {\n            cfg = cfg || null;\n            await loadStrings();\n            findElements();\n\n            config = buildConfig(cfg);\n\n            if (connectBtn) {\n                isConnected = connectBtn.classList.contains('btn-outline-primary') || Boolean(cfg && cfg.isConnected);\n                connectBtn.addEventListener('click', startConnection);\n            } else if (cfg) {\n                isConnected = Boolean(cfg.isConnected);\n            }\n        }\n    };\n});\n"],"mappings":"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","ignoreList":[]}