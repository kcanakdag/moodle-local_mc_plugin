{"version":3,"file":"connect.min.js","sources":["../src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n *\n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n *\n * Uses data-* attributes from connect_button.mustache template.\n *\n * @module     local_mc_plugin/connect\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './local/admin/selectors';\nimport * as Repository from './local/admin/repository';\nimport * as ConnectionStatus from './local/admin/connection_status';\nimport {get_strings as getStrings} from 'core/str';\n\nconst POLL_INTERVAL = 3000; // 3 seconds\nconst MAX_POLL_ATTEMPTS = 60; // 3 minutes total\n\n/** @type {Object} Configuration */\nlet config = {};\n\n/** @type {Object} Language strings */\nlet strings = {};\n\n/** @type {number|null} Poll timer ID */\nlet pollTimer = null;\n\n/** @type {number} Poll attempt counter */\nlet pollAttempts = 0;\n\n/** @type {string|null} Current connection token */\nlet currentToken = null;\n\n/** @type {boolean} Whether currently connected */\nlet isConnected = false;\n\n/** @type {HTMLElement|null} Connect button */\nlet connectBtn = null;\n\n/** @type {HTMLElement|null} Button text element */\nlet btnText = null;\n\n/** @type {HTMLElement|null} Button spinner element */\nlet btnSpinner = null;\n\n/** @type {HTMLElement|null} Status div element */\nlet statusDiv = null;\n\n/** @type {HTMLElement|null} Status icon element */\nlet statusIcon = null;\n\n/** @type {HTMLElement|null} Status text element */\nlet statusText = null;\n\n\n/**\n * Load language strings.\n *\n * @returns {Promise<void>}\n */\nconst loadStrings = async() => {\n    const results = await getStrings([\n        {key: 'connect_initializing', component: 'local_mc_plugin'},\n        {key: 'connect_waiting', component: 'local_mc_plugin'},\n        {key: 'connect_waiting_btn', component: 'local_mc_plugin'},\n        {key: 'connect_saving', component: 'local_mc_plugin'},\n        {key: 'connect_success', component: 'local_mc_plugin'},\n        {key: 'connect_popup_blocked', component: 'local_mc_plugin'},\n        {key: 'connect_init_failed', component: 'local_mc_plugin'},\n        {key: 'connect_timeout', component: 'local_mc_plugin'},\n        {key: 'connect_token_expired', component: 'local_mc_plugin'},\n        {key: 'connect_credentials_retrieved', component: 'local_mc_plugin'},\n        {key: 'connect_save_failed', component: 'local_mc_plugin'},\n        {key: 'connect_button', component: 'local_mc_plugin'},\n        {key: 'reconnect_button', component: 'local_mc_plugin'},\n    ]);\n\n    strings = {\n        initializing: results[0],\n        waiting: results[1],\n        waitingBtn: results[2],\n        saving: results[3],\n        success: results[4],\n        popupBlocked: results[5],\n        initFailed: results[6],\n        timeout: results[7],\n        tokenExpired: results[8],\n        credentialsRetrieved: results[9],\n        saveFailed: results[10],\n        connectBtn: results[11],\n        reconnectBtn: results[12],\n    };\n};\n\n/**\n * Find DOM elements using data-* attribute selectors.\n *\n * Falls back to legacy ID-based selectors for backward compatibility.\n */\nconst findElements = () => {\n    // Try data-* attribute selectors first (from template)\n    const container = document.querySelector(Selectors.connect.container);\n\n    if (container) {\n        connectBtn = container.querySelector(Selectors.connect.button);\n        btnText = container.querySelector(Selectors.connect.buttonText);\n        btnSpinner = container.querySelector(Selectors.connect.buttonSpinner);\n        statusDiv = container.querySelector(Selectors.connect.statusDiv);\n        statusIcon = container.querySelector(Selectors.connect.statusIcon);\n        statusText = container.querySelector(Selectors.connect.statusText);\n    } else {\n        // Fallback to legacy ID-based selectors\n        connectBtn = document.querySelector(Selectors.connect.legacyButton);\n        btnText = document.querySelector(Selectors.connect.legacyButtonText);\n        btnSpinner = document.querySelector(Selectors.connect.legacyButtonSpinner);\n        statusDiv = document.querySelector(Selectors.connect.legacyStatusDiv);\n        statusIcon = document.querySelector(Selectors.connect.legacyStatusIcon);\n        statusText = document.querySelector(Selectors.connect.legacyStatusText);\n    }\n};\n\n/**\n * Show status message.\n *\n * @param {string} type Status type: 'waiting', 'success', 'error'\n * @param {string} message Status message\n */\nconst showStatus = (type, message) => {\n    if (!statusDiv) {\n        return;\n    }\n\n    // Show the status div\n    statusDiv.classList.remove('d-none');\n    statusDiv.style.display = 'block';\n\n    // Remove previous alert classes\n    statusDiv.classList.remove('alert-warning', 'alert-success', 'alert-danger');\n\n    if (type === 'waiting') {\n        statusDiv.classList.add('alert-warning');\n        if (statusIcon) {\n            statusIcon.innerHTML = '<span class=\"spinner-border spinner-border-sm mr-2\"></span>';\n        }\n    } else if (type === 'success') {\n        statusDiv.classList.add('alert-success');\n        if (statusIcon) {\n            statusIcon.innerHTML = '✓ ';\n        }\n    } else if (type === 'error') {\n        statusDiv.classList.add('alert-danger');\n        if (statusIcon) {\n            statusIcon.innerHTML = '✗ ';\n        }\n    }\n\n    if (statusText) {\n        statusText.textContent = message;\n    }\n};\n\n/**\n * Hide status message.\n */\nconst hideStatus = () => {\n    if (statusDiv) {\n        statusDiv.classList.add('d-none');\n        statusDiv.style.display = 'none';\n    }\n};\n\n/**\n * Set loading state.\n *\n * @param {boolean} loading Whether loading\n */\nconst setLoading = (loading) => {\n    if (connectBtn) {\n        connectBtn.disabled = loading;\n    }\n    if (btnSpinner) {\n        if (loading) {\n            btnSpinner.classList.remove('d-none');\n        } else {\n            btnSpinner.classList.add('d-none');\n        }\n    }\n};\n\n/**\n * Set button text.\n *\n * @param {string} text Button text\n */\nconst setBtnText = (text) => {\n    if (btnText) {\n        btnText.textContent = text;\n    }\n};\n\n/**\n * Stop polling.\n */\nconst stopPolling = () => {\n    if (pollTimer) {\n        clearInterval(pollTimer);\n        pollTimer = null;\n    }\n};\n\n/**\n * Save credentials after successful connection.\n *\n * @param {string} siteKey Site key\n * @param {string} siteSecret Site secret\n */\nconst saveCredentials = async(siteKey, siteSecret) => {\n    showStatus('waiting', strings.saving);\n\n    try {\n        const data = await Repository.saveCredentials(config.saveUrl, config.sesskey, siteKey, siteSecret);\n\n        setLoading(false);\n\n        if (data.success) {\n            showStatus('success', strings.success);\n            setBtnText(strings.reconnectBtn);\n\n            if (connectBtn) {\n                connectBtn.classList.remove('btn-primary');\n                connectBtn.classList.add('btn-outline-primary');\n            }\n\n            isConnected = true;\n\n            // Refresh connection status\n            setTimeout(() => {\n                ConnectionStatus.testConnection();\n            }, 500);\n        } else {\n            showStatus('error', data.message || strings.saveFailed);\n        }\n    } catch (err) {\n        setLoading(false);\n        showStatus('error', `${strings.saveFailed}: ${err.message}`);\n    }\n};\n\n/**\n * Poll for connection status.\n */\nconst pollStatus = async() => {\n    pollAttempts++;\n\n    if (pollAttempts > MAX_POLL_ATTEMPTS) {\n        stopPolling();\n        setLoading(false);\n        showStatus('error', strings.timeout);\n        return;\n    }\n\n    try {\n        const data = await Repository.pollConnectionStatus(config.apiUrl, currentToken);\n\n        if (data.status === 'completed') {\n            stopPolling();\n\n            if (data.site_key && data.site_secret) {\n                saveCredentials(data.site_key, data.site_secret);\n            } else {\n                setLoading(false);\n                showStatus('error', strings.credentialsRetrieved);\n            }\n        } else if (data.status === 'expired') {\n            stopPolling();\n            setLoading(false);\n            showStatus('error', strings.tokenExpired);\n        }\n        // If pending, continue polling\n    } catch {\n        // Network error, but continue polling silently\n    }\n};\n\n/**\n * Get the appropriate button text based on connection state.\n *\n * @returns {string} Button text\n */\nconst getButtonText = () => {\n    return isConnected ? strings.reconnectBtn : strings.connectBtn;\n};\n\n/**\n * Reset button state after connection attempt.\n */\nconst resetButtonState = () => {\n    setLoading(false);\n    setBtnText(getButtonText());\n};\n\n/**\n * Handle successful token retrieval and open connection window.\n *\n * @param {Object} data Response data with token\n */\nconst handleTokenSuccess = (data) => {\n    currentToken = data.token;\n\n    // Open MoodleConnect in a new tab.\n    const connectPageUrl = `${config.frontendUrl}/connect?token=${encodeURIComponent(data.token)}`;\n    const connectWindow = window.open(connectPageUrl, '_blank');\n\n    if (!connectWindow) {\n        resetButtonState();\n        showStatus('error', strings.popupBlocked);\n        return;\n    }\n\n    setBtnText(strings.waitingBtn);\n    showStatus('waiting', strings.waiting);\n\n    // Start polling.\n    pollTimer = setInterval(pollStatus, POLL_INTERVAL);\n};\n\n/**\n * Start the connection flow.\n */\nconst startConnection = async() => {\n    hideStatus();\n    setLoading(true);\n    setBtnText(strings.initializing);\n    pollAttempts = 0;\n\n    try {\n        const data = await Repository.initConnection(config.connectUrl, config.sesskey);\n\n        if (data.success && data.token) {\n            handleTokenSuccess(data);\n        } else {\n            resetButtonState();\n            showStatus('error', data.message || strings.initFailed);\n        }\n    } catch (err) {\n        resetButtonState();\n        showStatus('error', `${strings.initFailed}: ${err.message}`);\n    }\n};\n\n/**\n * Get config value from button data attribute or fallback config.\n *\n * @param {string} dataAttr Data attribute name (lowercase)\n * @param {string} cfgKey Config key name\n * @param {Object|null} cfg Fallback config object\n * @returns {string} Config value\n */\nconst getConfigValue = (dataAttr, cfgKey, cfg) => {\n    if (connectBtn && connectBtn.dataset[dataAttr]) {\n        return connectBtn.dataset[dataAttr];\n    }\n    if (cfg && cfg[cfgKey]) {\n        return cfg[cfgKey];\n    }\n    return '';\n};\n\n/**\n * Build configuration from button data attributes or fallback config.\n *\n * @param {Object|null} cfg Fallback config object\n * @returns {Object} Configuration object\n */\nconst buildConfig = (cfg) => {\n    return {\n        connectUrl: getConfigValue('connecturl', 'connectUrl', cfg),\n        saveUrl: getConfigValue('saveurl', 'saveUrl', cfg),\n        apiUrl: getConfigValue('apiurl', 'apiUrl', cfg),\n        frontendUrl: getConfigValue('frontendurl', 'frontendUrl', cfg),\n        sesskey: getConfigValue('sesskey', 'sesskey', cfg),\n    };\n};\n\n/**\n * Initialize the connect module.\n *\n * Reads configuration from data attributes on the connect button,\n * or accepts a configuration object for backward compatibility.\n *\n * @param {Object} [cfg] Optional configuration object\n * @param {string} [cfg.connectUrl] URL to connect.php\n * @param {string} [cfg.saveUrl] URL to ajax_save.php\n * @param {string} [cfg.apiUrl] MoodleConnect API URL\n * @param {string} [cfg.frontendUrl] MoodleConnect frontend URL\n * @param {string} [cfg.sesskey] Moodle session key\n * @param {boolean} [cfg.isConnected] Whether already connected\n */\nexport const init = async(cfg = null) => {\n    await loadStrings();\n    findElements();\n\n    config = buildConfig(cfg);\n\n    if (connectBtn) {\n        isConnected = connectBtn.classList.contains('btn-outline-primary') || Boolean(cfg && cfg.isConnected);\n        connectBtn.addEventListener('click', startConnection);\n    } else if (cfg) {\n        isConnected = Boolean(cfg.isConnected);\n    }\n};\n"],"names":["config","strings","pollTimer","pollAttempts","currentToken","isConnected","connectBtn","btnText","btnSpinner","statusDiv","statusIcon","statusText","loadStrings","async","results","key","component","initializing","waiting","waitingBtn","saving","success","popupBlocked","initFailed","timeout","tokenExpired","credentialsRetrieved","saveFailed","reconnectBtn","findElements","container","document","querySelector","Selectors","connect","button","buttonText","buttonSpinner","legacyButton","legacyButtonText","legacyButtonSpinner","legacyStatusDiv","legacyStatusIcon","legacyStatusText","showStatus","type","message","classList","remove","style","display","add","innerHTML","textContent","setLoading","loading","disabled","setBtnText","text","stopPolling","clearInterval","pollStatus","data","Repository","pollConnectionStatus","apiUrl","status","site_key","site_secret","siteKey","siteSecret","saveCredentials","saveUrl","sesskey","setTimeout","ConnectionStatus","testConnection","err","resetButtonState","startConnection","initConnection","connectUrl","token","connectPageUrl","frontendUrl","encodeURIComponent","window","open","setInterval","handleTokenSuccess","getConfigValue","dataAttr","cfgKey","cfg","dataset","buildConfig","contains","Boolean","addEventListener"],"mappings":"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"}