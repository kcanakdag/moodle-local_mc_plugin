{"version":3,"file":"connect.min.js","sources":["../src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n *\n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n *\n * Uses data-* attributes from connect_button.mustache template.\n *\n * @module     local_mc_plugin/connect\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'local_mc_plugin/local/admin/selectors',\n    'local_mc_plugin/local/admin/repository',\n    'local_mc_plugin/local/admin/connection_status',\n    'core/str'\n], function(Selectors, Repository, ConnectionStatus, Str) {\n    \"use strict\";\n\n    const POLL_INTERVAL = 3000; // 3 seconds\n    const MAX_POLL_ATTEMPTS = 60; // 3 minutes total\n\n    /** @type {Object} Configuration */\n    let config = {};\n\n    /** @type {Object} Language strings */\n    let strings = {};\n\n    /** @type {number|null} Poll timer ID */\n    let pollTimer = null;\n\n    /** @type {number} Poll attempt counter */\n    let pollAttempts = 0;\n\n    /** @type {string|null} Current connection token */\n    let currentToken = null;\n\n    /** @type {boolean} Whether currently connected */\n    let isConnected = false;\n\n    /** @type {HTMLElement|null} Connect button */\n    let connectBtn = null;\n\n    /** @type {HTMLElement|null} Button text element */\n    let btnText = null;\n\n    /** @type {HTMLElement|null} Button spinner element */\n    let btnSpinner = null;\n\n    /** @type {HTMLElement|null} Status div element */\n    let statusDiv = null;\n\n    /** @type {HTMLElement|null} Status icon element */\n    let statusIcon = null;\n\n    /** @type {HTMLElement|null} Status text element */\n    let statusText = null;\n\n\n    /**\n     * Load language strings.\n     *\n     * @returns {Promise<void>}\n     */\n    const loadStrings = async() => {\n        const results = await Str.get_strings([\n            {key: 'connect_initializing', component: 'local_mc_plugin'},\n            {key: 'connect_waiting', component: 'local_mc_plugin'},\n            {key: 'connect_waiting_btn', component: 'local_mc_plugin'},\n            {key: 'connect_saving', component: 'local_mc_plugin'},\n            {key: 'connect_success', component: 'local_mc_plugin'},\n            {key: 'connect_popup_fallback', component: 'local_mc_plugin'},\n            {key: 'connect_popup_open_link', component: 'local_mc_plugin'},\n            {key: 'connect_init_failed', component: 'local_mc_plugin'},\n            {key: 'connect_timeout', component: 'local_mc_plugin'},\n            {key: 'connect_token_expired', component: 'local_mc_plugin'},\n            {key: 'connect_credentials_retrieved', component: 'local_mc_plugin'},\n            {key: 'connect_save_failed', component: 'local_mc_plugin'},\n            {key: 'connect_button', component: 'local_mc_plugin'},\n            {key: 'reconnect_button', component: 'local_mc_plugin'},\n        ]);\n\n        strings = {\n            initializing: results[0],\n            waiting: results[1],\n            waitingBtn: results[2],\n            saving: results[3],\n            success: results[4],\n            popupFallback: results[5],\n            popupOpenLink: results[6],\n            initFailed: results[7],\n            timeout: results[8],\n            tokenExpired: results[9],\n            credentialsRetrieved: results[10],\n            saveFailed: results[11],\n            connectBtn: results[12],\n            reconnectBtn: results[13],\n        };\n    };\n\n    /**\n     * Find DOM elements using data-* attribute selectors.\n     */\n    const findElements = () => {\n        // Try data-* attribute selectors first (from template)\n        const container = document.querySelector(Selectors.connect.container);\n\n        if (container) {\n            connectBtn = container.querySelector(Selectors.connect.button);\n            btnText = container.querySelector(Selectors.connect.buttonText);\n            btnSpinner = container.querySelector(Selectors.connect.buttonSpinner);\n            statusDiv = container.querySelector(Selectors.connect.statusDiv);\n            statusIcon = container.querySelector(Selectors.connect.statusIcon);\n            statusText = container.querySelector(Selectors.connect.statusText);\n        } else {\n            // Fallback to legacy ID-based selectors\n            connectBtn = document.querySelector(Selectors.connect.legacyButton);\n            btnText = document.querySelector(Selectors.connect.legacyButtonText);\n            btnSpinner = document.querySelector(Selectors.connect.legacyButtonSpinner);\n            statusDiv = document.querySelector(Selectors.connect.legacyStatusDiv);\n            statusIcon = document.querySelector(Selectors.connect.legacyStatusIcon);\n            statusText = document.querySelector(Selectors.connect.legacyStatusText);\n        }\n    };\n\n    /**\n     * Show status message.\n     *\n     * @param {string} type Status type: 'waiting', 'success', 'error'\n     * @param {string} message Status message\n     */\n    const showStatus = (type, message) => {\n        if (!statusDiv) {\n            return;\n        }\n\n        // Show the status div\n        statusDiv.classList.remove('d-none');\n        statusDiv.style.display = 'block';\n\n        // Remove previous alert classes\n        statusDiv.classList.remove('alert-warning', 'alert-success', 'alert-danger');\n\n        if (type === 'waiting') {\n            statusDiv.classList.add('alert-warning');\n            if (statusIcon) {\n                statusIcon.innerHTML = '<span class=\"spinner-border spinner-border-sm mr-2\"></span>';\n            }\n        } else if (type === 'success') {\n            statusDiv.classList.add('alert-success');\n            if (statusIcon) {\n                statusIcon.innerHTML = '✓ ';\n            }\n        } else if (type === 'error') {\n            statusDiv.classList.add('alert-danger');\n            if (statusIcon) {\n                statusIcon.innerHTML = '✗ ';\n            }\n        }\n\n        if (statusText) {\n            statusText.textContent = message;\n        }\n    };\n\n    /**\n     * Hide status message.\n     */\n    const hideStatus = () => {\n        if (statusDiv) {\n            statusDiv.classList.add('d-none');\n            statusDiv.style.display = 'none';\n        }\n    };\n\n    /**\n     * Set loading state.\n     *\n     * @param {boolean} loading Whether loading\n     */\n    const setLoading = (loading) => {\n        if (connectBtn) {\n            connectBtn.disabled = loading;\n        }\n        if (btnSpinner) {\n            if (loading) {\n                btnSpinner.classList.remove('d-none');\n            } else {\n                btnSpinner.classList.add('d-none');\n            }\n        }\n    };\n\n    /**\n     * Set button text.\n     *\n     * @param {string} text Button text\n     */\n    const setBtnText = (text) => {\n        if (btnText) {\n            btnText.textContent = text;\n        }\n    };\n\n    /**\n     * Stop polling.\n     */\n    const stopPolling = () => {\n        if (pollTimer) {\n            clearInterval(pollTimer);\n            pollTimer = null;\n        }\n    };\n\n    /**\n     * Save credentials after successful connection.\n     *\n     * @param {string} siteKey Site key\n     * @param {string} siteSecret Site secret\n     */\n    const saveCredentials = async(siteKey, siteSecret) => {\n        showStatus('waiting', strings.saving);\n\n        try {\n            const data = await Repository.saveCredentials(config.saveUrl, config.sesskey, siteKey, siteSecret);\n\n            setLoading(false);\n\n            if (data.success) {\n                showStatus('success', strings.success);\n                setBtnText(strings.reconnectBtn);\n\n                if (connectBtn) {\n                    connectBtn.classList.remove('btn-primary');\n                    connectBtn.classList.add('btn-outline-primary');\n                }\n\n                isConnected = true;\n\n                // Refresh connection status and sync all events\n                setTimeout(() => {\n                    ConnectionStatus.testConnection(true);\n                }, 500);\n            } else {\n                showStatus('error', data.message || strings.saveFailed);\n            }\n        } catch (err) {\n            setLoading(false);\n            showStatus('error', `${strings.saveFailed}: ${err.message}`);\n        }\n    };\n\n    /**\n     * Poll for connection status.\n     */\n    const pollStatus = async() => {\n        pollAttempts++;\n\n        if (pollAttempts > MAX_POLL_ATTEMPTS) {\n            stopPolling();\n            setLoading(false);\n            showStatus('error', strings.timeout);\n            return;\n        }\n\n        try {\n            const data = await Repository.pollConnectionStatus(config.apiUrl, currentToken);\n\n            if (data.status === 'completed') {\n                stopPolling();\n\n                if (data.site_key && data.site_secret) {\n                    saveCredentials(data.site_key, data.site_secret);\n                } else {\n                    setLoading(false);\n                    showStatus('error', strings.credentialsRetrieved);\n                }\n            } else if (data.status === 'expired') {\n                stopPolling();\n                setLoading(false);\n                showStatus('error', strings.tokenExpired);\n            }\n            // If pending, continue polling\n        } catch (e) {\n            // Network error, but continue polling silently\n        }\n    };\n\n    /**\n     * Get the appropriate button text based on connection state.\n     *\n     * @returns {string} Button text\n     */\n    const getButtonText = () => {\n        return isConnected ? strings.reconnectBtn : strings.connectBtn;\n    };\n\n    /**\n     * Reset button state after connection attempt.\n     */\n    const resetButtonState = () => {\n        setLoading(false);\n        setBtnText(getButtonText());\n    };\n\n    /**\n     * Handle successful token retrieval and open connection window.\n     *\n     * @param {Object} data Response data with token\n     */\n    const handleTokenSuccess = (data) => {\n        currentToken = data.token;\n\n        // Build the connect URL and attempt to open in a new tab.\n        const connectPageUrl = `${config.frontendUrl}/connect?token=${encodeURIComponent(data.token)}`;\n        window.open(connectPageUrl, '_blank');\n\n        setBtnText(strings.waitingBtn);\n        showStatus('waiting', strings.waiting);\n\n        // Always append a fallback link in case the new tab didn't open (popup blockers, etc).\n        if (statusText) {\n            const fallback = document.createElement('span');\n            fallback.style.display = 'block';\n            fallback.style.marginTop = '0.5rem';\n            fallback.textContent = strings.popupFallback + ' ';\n\n            const link = document.createElement('a');\n            link.href = connectPageUrl;\n            link.target = '_blank';\n            link.rel = 'noopener';\n            link.textContent = strings.popupOpenLink;\n            link.style.fontWeight = 'bold';\n\n            fallback.appendChild(link);\n            statusText.appendChild(fallback);\n        }\n\n        // Start polling.\n        pollTimer = setInterval(pollStatus, POLL_INTERVAL);\n    };\n\n    /**\n     * Start the connection flow.\n     */\n    const startConnection = async() => {\n        hideStatus();\n        setLoading(true);\n        setBtnText(strings.initializing);\n        pollAttempts = 0;\n\n        try {\n            const data = await Repository.initConnection(config.connectUrl, config.sesskey);\n\n            if (data.success && data.token) {\n                handleTokenSuccess(data);\n            } else {\n                resetButtonState();\n                showStatus('error', data.message || strings.initFailed);\n            }\n        } catch (err) {\n            resetButtonState();\n            showStatus('error', `${strings.initFailed}: ${err.message}`);\n        }\n    };\n\n    /**\n     * Get config value from button data attribute or fallback config.\n     *\n     * @param {string} dataAttr Data attribute name (lowercase)\n     * @param {string} cfgKey Config key name\n     * @param {Object|null} cfg Fallback config object\n     * @returns {string} Config value\n     */\n    const getConfigValue = (dataAttr, cfgKey, cfg) => {\n        if (connectBtn && connectBtn.dataset[dataAttr]) {\n            return connectBtn.dataset[dataAttr];\n        }\n        if (cfg && cfg[cfgKey]) {\n            return cfg[cfgKey];\n        }\n        return '';\n    };\n\n    /**\n     * Build configuration from button data attributes or fallback config.\n     *\n     * @param {Object|null} cfg Fallback config object\n     * @returns {Object} Configuration object\n     */\n    const buildConfig = (cfg) => {\n        return {\n            connectUrl: getConfigValue('connecturl', 'connectUrl', cfg),\n            saveUrl: getConfigValue('saveurl', 'saveUrl', cfg),\n            apiUrl: getConfigValue('apiurl', 'apiUrl', cfg),\n            frontendUrl: getConfigValue('frontendurl', 'frontendUrl', cfg),\n            sesskey: getConfigValue('sesskey', 'sesskey', cfg),\n        };\n    };\n\n    return {\n        /**\n         * Initialize the connect module.\n         *\n         * @param {Object} [cfg] Optional configuration object\n         */\n        init: async function(cfg) {\n            cfg = cfg || null;\n            await loadStrings();\n            findElements();\n\n            config = buildConfig(cfg);\n\n            if (connectBtn) {\n                isConnected = connectBtn.classList.contains('btn-outline-primary') || Boolean(cfg && cfg.isConnected);\n                connectBtn.addEventListener('click', startConnection);\n            } else if (cfg) {\n                isConnected = Boolean(cfg.isConnected);\n            }\n        }\n    };\n});\n"],"names":["define","Selectors","Repository","ConnectionStatus","Str","config","strings","pollTimer","pollAttempts","currentToken","isConnected","connectBtn","btnText","btnSpinner","statusDiv","statusIcon","statusText","showStatus","type","message","classList","remove","style","display","add","innerHTML","textContent","setLoading","loading","disabled","setBtnText","text","stopPolling","clearInterval","pollStatus","async","timeout","data","pollConnectionStatus","apiUrl","status","site_key","site_secret","siteKey","siteSecret","saving","saveCredentials","saveUrl","sesskey","success","reconnectBtn","setTimeout","testConnection","saveFailed","err","credentialsRetrieved","tokenExpired","e","resetButtonState","startConnection","initializing","initConnection","connectUrl","token","connectPageUrl","frontendUrl","encodeURIComponent","window","open","waitingBtn","waiting","fallback","document","createElement","marginTop","popupFallback","link","href","target","rel","popupOpenLink","fontWeight","appendChild","setInterval","handleTokenSuccess","initFailed","getConfigValue","dataAttr","cfgKey","cfg","dataset","init","results","get_strings","key","component","loadStrings","container","querySelector","connect","button","buttonText","buttonSpinner","legacyButton","legacyButtonText","legacyButtonSpinner","legacyStatusDiv","legacyStatusIcon","legacyStatusText","findElements","buildConfig","contains","Boolean","addEventListener"],"mappings":"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"}