{"version":3,"file":"connect.min.js","sources":["../src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n *\n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n *\n * @module     local_mc_plugin/connect\n */\n\ndefine(['jquery'], function($) {\n\n    var POLL_INTERVAL = 3000; // 3 seconds.\n    var MAX_POLL_ATTEMPTS = 60; // 3 minutes total.\n\n    var pollTimer = null;\n    var pollAttempts = 0;\n    var currentToken = null;\n    var connectWindow = null;\n\n    /**\n     * Get the MoodleConnect frontend URL from the API URL.\n     * Converts https://moodleconnect.com/api to https://moodleconnect.com\n     *\n     * @param {string} apiUrl The API URL\n     * @return {string} The frontend URL\n     */\n    function getFrontendUrl(apiUrl) {\n        // Remove /api suffix to get frontend URL.\n        return apiUrl.replace(/\\/api\\/?$/, '');\n    }\n\n    /**\n     * Initialize the connection flow.\n     *\n     * @param {Object} config Configuration object\n     * @param {string} config.connectUrl URL to connect.php AJAX endpoint\n     * @param {string} config.statusUrl URL to check connection status\n     * @param {string} config.saveUrl URL to save credentials\n     * @param {string} config.apiUrl MoodleConnect API URL\n     * @param {string} config.sesskey Moodle session key\n     * @param {Function} config.onStatusChange Callback for status changes\n     * @param {Function} config.onSuccess Callback for successful connection\n     * @param {Function} config.onError Callback for errors\n     */\n    function init(config) {\n        return {\n            startConnection: function() {\n                startConnection(config);\n            },\n            stopPolling: stopPolling\n        };\n    }\n\n    /**\n     * Start the connection flow.\n     *\n     * @param {Object} config Configuration object\n     */\n    function startConnection(config) {\n        // Reset state.\n        stopPolling();\n        pollAttempts = 0;\n\n        config.onStatusChange('initializing', M.util.get_string('connect_initializing', 'local_mc_plugin'));\n\n        // Request a connection token from our backend.\n        $.ajax({\n            url: config.connectUrl,\n            method: 'POST',\n            data: {\n                action: 'init',\n                sesskey: config.sesskey\n            },\n            dataType: 'json'\n        }).done(function(response) {\n            if (response.success && response.token) {\n                currentToken = response.token;\n\n                // Open MoodleConnect in a new tab.\n                var frontendUrl = getFrontendUrl(config.apiUrl);\n                var connectPageUrl = frontendUrl + '/connect?token=' + encodeURIComponent(response.token);\n\n                connectWindow = window.open(connectPageUrl, '_blank');\n\n                if (!connectWindow) {\n                    config.onError(M.util.get_string('connect_popup_blocked', 'local_mc_plugin'));\n                    return;\n                }\n\n                config.onStatusChange('waiting', M.util.get_string('connect_waiting', 'local_mc_plugin'));\n\n                // Start polling for completion.\n                startPolling(config);\n            } else {\n                config.onError(response.message || M.util.get_string('connect_init_failed', 'local_mc_plugin'));\n            }\n        }).fail(function(xhr, status, error) {\n            config.onError(M.util.get_string('connect_init_failed', 'local_mc_plugin') + ': ' + error);\n        });\n    }\n\n    /**\n     * Start polling for connection completion.\n     *\n     * @param {Object} config Configuration object\n     */\n    function startPolling(config) {\n        pollTimer = setInterval(function() {\n            pollAttempts++;\n\n            if (pollAttempts > MAX_POLL_ATTEMPTS) {\n                stopPolling();\n                config.onError(M.util.get_string('connect_timeout', 'local_mc_plugin'));\n                return;\n            }\n\n            // Poll the MoodleConnect API for status.\n            $.ajax({\n                url: config.apiUrl + '/connect/status',\n                method: 'GET',\n                data: {\n                    token: currentToken\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (response.status === 'completed') {\n                    stopPolling();\n\n                    if (response.site_key && response.site_secret) {\n                        // Save credentials.\n                        saveCredentials(config, response.site_key, response.site_secret);\n                    } else {\n                        // Credentials already retrieved.\n                        config.onError(M.util.get_string('connect_credentials_retrieved', 'local_mc_plugin'));\n                    }\n                } else if (response.status === 'expired') {\n                    stopPolling();\n                    config.onError(M.util.get_string('connect_token_expired', 'local_mc_plugin'));\n                } else if (response.status === 'pending') {\n                    // Still waiting, continue polling.\n                    config.onStatusChange('waiting', M.util.get_string('connect_waiting', 'local_mc_plugin'));\n                }\n            }).fail(function() {\n                // Network error, but don't stop polling yet.\n                // Silently continue polling.\n            });\n        }, POLL_INTERVAL);\n    }\n\n    /**\n     * Stop the polling timer.\n     */\n    function stopPolling() {\n        if (pollTimer) {\n            clearInterval(pollTimer);\n            pollTimer = null;\n        }\n    }\n\n    /**\n     * Save credentials to Moodle settings.\n     *\n     * @param {Object} config Configuration object\n     * @param {string} siteKey The site key\n     * @param {string} siteSecret The site secret\n     */\n    function saveCredentials(config, siteKey, siteSecret) {\n        config.onStatusChange('saving', M.util.get_string('connect_saving', 'local_mc_plugin'));\n\n        $.ajax({\n            url: config.saveUrl,\n            method: 'POST',\n            data: {\n                action: 'save',\n                sesskey: config.sesskey,\n                siteKey: siteKey,\n                siteSecret: siteSecret\n            },\n            dataType: 'json'\n        }).done(function(response) {\n            if (response.success) {\n                config.onSuccess(siteKey);\n            } else {\n                config.onError(response.message || M.util.get_string('connect_save_failed', 'local_mc_plugin'));\n            }\n        }).fail(function(xhr, status, error) {\n            config.onError(M.util.get_string('connect_save_failed', 'local_mc_plugin') + ': ' + error);\n        });\n    }\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","pollTimer","pollAttempts","currentToken","stopPolling","clearInterval","init","config","startConnection","onStatusChange","M","util","get_string","ajax","url","connectUrl","method","data","action","sesskey","dataType","done","response","success","token","connectPageUrl","apiUrl","replace","encodeURIComponent","window","open","onError","setInterval","status","site_key","site_secret","siteKey","siteSecret","saveUrl","onSuccess","message","fail","xhr","error","saveCredentials","startPolling"],"mappings":"AAWAA,iCAAO,CAAC,WAAW,SAASC,OAKpBC,UAAY,KACZC,aAAe,EACfC,aAAe,cAwIVC,cACDH,YACAI,cAAcJ,WACdA,UAAY,YAmCb,CACHK,cAnJUC,cACH,CACHC,gBAAiB,qBAYAD,QAErBH,cACAF,aAAe,EAEfK,OAAOE,eAAe,eAAgBC,EAAEC,KAAKC,WAAW,uBAAwB,oBAGhFZ,EAAEa,KAAK,CACHC,IAAKP,OAAOQ,WACZC,OAAQ,OACRC,KAAM,CACFC,OAAQ,OACRC,QAASZ,OAAOY,SAEpBC,SAAU,SACXC,MAAK,SAASC,aACTA,SAASC,SAAWD,SAASE,MAAO,CACpCrB,aAAemB,SAASE,UAIpBC,eAD6BlB,OAAOmB,OAnDlCC,QAAQ,YAAa,IAoDQ,kBAAoBC,mBAAmBN,SAASE,WAEnEK,OAAOC,KAAKL,eAAgB,sBAGxClB,OAAOwB,QAAQrB,EAAEC,KAAKC,WAAW,wBAAyB,oBAI9DL,OAAOE,eAAe,UAAWC,EAAEC,KAAKC,WAAW,kBAAmB,6BAiB5DL,QAClBN,UAAY+B,aAAY,gBACpB9B,aAhGgB,UAmGZE,mBACAG,OAAOwB,QAAQrB,EAAEC,KAAKC,WAAW,kBAAmB,oBAKxDZ,EAAEa,KAAK,CACHC,IAAKP,OAAOmB,OAAS,kBACrBV,OAAQ,MACRC,KAAM,CACFO,MAAOrB,cAEXiB,SAAU,SACXC,MAAK,SAASC,UACW,cAApBA,SAASW,QACT7B,cAEIkB,SAASY,UAAYZ,SAASa,qBAsCzB5B,OAAQ6B,QAASC,YACtC9B,OAAOE,eAAe,SAAUC,EAAEC,KAAKC,WAAW,iBAAkB,oBAEpEZ,EAAEa,KAAK,CACHC,IAAKP,OAAO+B,QACZtB,OAAQ,OACRC,KAAM,CACFC,OAAQ,OACRC,QAASZ,OAAOY,QAChBiB,QAASA,QACTC,WAAYA,YAEhBjB,SAAU,SACXC,MAAK,SAASC,UACTA,SAASC,QACThB,OAAOgC,UAAUH,SAEjB7B,OAAOwB,QAAQT,SAASkB,SAAW9B,EAAEC,KAAKC,WAAW,sBAAuB,uBAEjF6B,MAAK,SAASC,IAAKT,OAAQU,OAC1BpC,OAAOwB,QAAQrB,EAAEC,KAAKC,WAAW,sBAAuB,mBAAqB,KAAO+B,UAxDxEC,CAAgBrC,OAAQe,SAASY,SAAUZ,SAASa,aAGpD5B,OAAOwB,QAAQrB,EAAEC,KAAKC,WAAW,gCAAiC,qBAE3C,YAApBU,SAASW,QAChB7B,cACAG,OAAOwB,QAAQrB,EAAEC,KAAKC,WAAW,wBAAyB,qBAC/B,YAApBU,SAASW,QAEhB1B,OAAOE,eAAe,UAAWC,EAAEC,KAAKC,WAAW,kBAAmB,uBAE3E6B,MAAK,iBAnII,KAiFRI,CAAatC,aAEbA,OAAOwB,QAAQT,SAASkB,SAAW9B,EAAEC,KAAKC,WAAW,sBAAuB,uBAEjF6B,MAAK,SAASC,IAAKT,OAAQU,OAC1BpC,OAAOwB,QAAQrB,EAAEC,KAAKC,WAAW,sBAAuB,mBAAqB,KAAO+B,UAlDhFnC,CAAgBD,SAEpBH,YAAaA"}