{"version":3,"file":"connect.min.js","sources":["../src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n *\n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n *\n * @module     local_mc_plugin/connect\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './local/admin/repository';\nimport * as ConnectionStatus from './local/admin/connection_status';\nimport {get_strings as getStrings} from 'core/str';\n\nconst POLL_INTERVAL = 3000; // 3 seconds\nconst MAX_POLL_ATTEMPTS = 60; // 3 minutes total\n\n/** @type {Object} Configuration */\nlet config = {};\n\n/** @type {Object} Language strings */\nlet strings = {};\n\n/** @type {number|null} Poll timer ID */\nlet pollTimer = null;\n\n/** @type {number} Poll attempt counter */\nlet pollAttempts = 0;\n\n/** @type {string|null} Current connection token */\nlet currentToken = null;\n\n/** @type {boolean} Whether currently connected */\nlet isConnected = false;\n\n/**\n * Load language strings.\n *\n * @returns {Promise<void>}\n */\nconst loadStrings = async() => {\n    const results = await getStrings([\n        {key: 'connect_initializing', component: 'local_mc_plugin'},\n        {key: 'connect_waiting', component: 'local_mc_plugin'},\n        {key: 'connect_waiting_btn', component: 'local_mc_plugin'},\n        {key: 'connect_saving', component: 'local_mc_plugin'},\n        {key: 'connect_success', component: 'local_mc_plugin'},\n        {key: 'connect_popup_blocked', component: 'local_mc_plugin'},\n        {key: 'connect_init_failed', component: 'local_mc_plugin'},\n        {key: 'connect_timeout', component: 'local_mc_plugin'},\n        {key: 'connect_token_expired', component: 'local_mc_plugin'},\n        {key: 'connect_credentials_retrieved', component: 'local_mc_plugin'},\n        {key: 'connect_save_failed', component: 'local_mc_plugin'},\n        {key: 'connect_button', component: 'local_mc_plugin'},\n        {key: 'reconnect_button', component: 'local_mc_plugin'},\n    ]);\n\n    strings = {\n        initializing: results[0],\n        waiting: results[1],\n        waitingBtn: results[2],\n        saving: results[3],\n        success: results[4],\n        popupBlocked: results[5],\n        initFailed: results[6],\n        timeout: results[7],\n        tokenExpired: results[8],\n        credentialsRetrieved: results[9],\n        saveFailed: results[10],\n        connectBtn: results[11],\n        reconnectBtn: results[12],\n    };\n};\n\n/**\n * Get DOM elements.\n *\n * @returns {Object} DOM elements\n */\nconst getElements = () => ({\n    connectBtn: document.getElementById('mc-connect-btn'),\n    btnText: document.getElementById('mc-connect-btn-text'),\n    btnSpinner: document.getElementById('mc-connect-btn-spinner'),\n    statusDiv: document.getElementById('mc-connect-status'),\n    statusIcon: document.getElementById('mc-connect-status-icon'),\n    statusText: document.getElementById('mc-connect-status-text'),\n});\n\n/**\n * Show status message.\n *\n * @param {string} type Status type: 'waiting', 'success', 'error'\n * @param {string} message Status message\n */\nconst showStatus = (type, message) => {\n    const {statusDiv, statusIcon, statusText} = getElements();\n    if (!statusDiv) {\n        return;\n    }\n\n    statusDiv.style.display = 'block';\n\n    if (type === 'waiting') {\n        statusDiv.style.background = '#fff3cd';\n        statusDiv.style.color = '#856404';\n        statusIcon.innerHTML = '<span class=\"spinner-border spinner-border-sm\" style=\"margin-right: 8px;\"></span>';\n    } else if (type === 'success') {\n        statusDiv.style.background = '#d4edda';\n        statusDiv.style.color = '#155724';\n        statusIcon.innerHTML = '✓ ';\n    } else if (type === 'error') {\n        statusDiv.style.background = '#f8d7da';\n        statusDiv.style.color = '#721c24';\n        statusIcon.innerHTML = '✗ ';\n    }\n\n    statusText.textContent = message;\n};\n\n/**\n * Hide status message.\n */\nconst hideStatus = () => {\n    const {statusDiv} = getElements();\n    if (statusDiv) {\n        statusDiv.style.display = 'none';\n    }\n};\n\n/**\n * Set loading state.\n *\n * @param {boolean} loading Whether loading\n */\nconst setLoading = (loading) => {\n    const {connectBtn, btnSpinner} = getElements();\n    if (connectBtn) {\n        connectBtn.disabled = loading;\n    }\n    if (btnSpinner) {\n        btnSpinner.style.display = loading ? 'inline-block' : 'none';\n    }\n};\n\n/**\n * Set button text.\n *\n * @param {string} text Button text\n */\nconst setBtnText = (text) => {\n    const {btnText} = getElements();\n    if (btnText) {\n        btnText.textContent = text;\n    }\n};\n\n/**\n * Stop polling.\n */\nconst stopPolling = () => {\n    if (pollTimer) {\n        clearInterval(pollTimer);\n        pollTimer = null;\n    }\n};\n\n/**\n * Save credentials after successful connection.\n *\n * @param {string} siteKey Site key\n * @param {string} siteSecret Site secret\n */\nconst saveCredentials = async(siteKey, siteSecret) => {\n    showStatus('waiting', strings.saving);\n\n    try {\n        const data = await Repository.saveCredentials(config.saveUrl, config.sesskey, siteKey, siteSecret);\n\n        setLoading(false);\n\n        if (data.success) {\n            showStatus('success', strings.success);\n            setBtnText(strings.reconnectBtn);\n\n            const {connectBtn} = getElements();\n            if (connectBtn) {\n                connectBtn.classList.remove('btn-primary');\n                connectBtn.classList.add('btn-outline-primary');\n            }\n\n            isConnected = true;\n\n            // Refresh connection status\n            setTimeout(() => {\n                ConnectionStatus.testConnection();\n            }, 500);\n        } else {\n            showStatus('error', data.message || strings.saveFailed);\n        }\n    } catch (err) {\n        setLoading(false);\n        showStatus('error', `${strings.saveFailed}: ${err.message}`);\n    }\n};\n\n/**\n * Poll for connection status.\n */\nconst pollStatus = async() => {\n    pollAttempts++;\n\n    if (pollAttempts > MAX_POLL_ATTEMPTS) {\n        stopPolling();\n        setLoading(false);\n        showStatus('error', strings.timeout);\n        return;\n    }\n\n    try {\n        const data = await Repository.pollConnectionStatus(config.apiUrl, currentToken);\n\n        if (data.status === 'completed') {\n            stopPolling();\n\n            if (data.site_key && data.site_secret) {\n                saveCredentials(data.site_key, data.site_secret);\n            } else {\n                setLoading(false);\n                showStatus('error', strings.credentialsRetrieved);\n            }\n        } else if (data.status === 'expired') {\n            stopPolling();\n            setLoading(false);\n            showStatus('error', strings.tokenExpired);\n        }\n        // If pending, continue polling\n    } catch {\n        // Network error, but continue polling silently\n    }\n};\n\n/**\n * Start the connection flow.\n */\nconst startConnection = async() => {\n    hideStatus();\n    setLoading(true);\n    setBtnText(strings.initializing);\n    pollAttempts = 0;\n\n    try {\n        const data = await Repository.initConnection(config.connectUrl, config.sesskey);\n\n        if (data.success && data.token) {\n            currentToken = data.token;\n\n            // Open MoodleConnect in a new tab\n            const connectPageUrl = `${config.frontendUrl}/connect?token=${encodeURIComponent(data.token)}`;\n            const connectWindow = window.open(connectPageUrl, '_blank');\n\n            if (!connectWindow) {\n                setLoading(false);\n                setBtnText(isConnected ? strings.reconnectBtn : strings.connectBtn);\n                showStatus('error', strings.popupBlocked);\n                return;\n            }\n\n            setBtnText(strings.waitingBtn);\n            showStatus('waiting', strings.waiting);\n\n            // Start polling\n            pollTimer = setInterval(pollStatus, POLL_INTERVAL);\n        } else {\n            setLoading(false);\n            setBtnText(isConnected ? strings.reconnectBtn : strings.connectBtn);\n            showStatus('error', data.message || strings.initFailed);\n        }\n    } catch (err) {\n        setLoading(false);\n        setBtnText(isConnected ? strings.reconnectBtn : strings.connectBtn);\n        showStatus('error', `${strings.initFailed}: ${err.message}`);\n    }\n};\n\n/**\n * Initialize the connect module.\n *\n * @param {Object} cfg Configuration object\n * @param {string} cfg.connectUrl URL to connect.php\n * @param {string} cfg.saveUrl URL to ajax_save.php\n * @param {string} cfg.apiUrl MoodleConnect API URL\n * @param {string} cfg.frontendUrl MoodleConnect frontend URL\n * @param {string} cfg.sesskey Moodle session key\n * @param {boolean} cfg.isConnected Whether already connected\n */\nexport const init = async(cfg) => {\n    config = cfg;\n    isConnected = cfg.isConnected || false;\n\n    await loadStrings();\n\n    const {connectBtn} = getElements();\n    if (connectBtn) {\n        connectBtn.addEventListener('click', startConnection);\n    }\n};\n"],"names":["config","strings","pollTimer","pollAttempts","currentToken","isConnected","getElements","connectBtn","document","getElementById","btnText","btnSpinner","statusDiv","statusIcon","statusText","showStatus","type","message","style","display","background","color","innerHTML","textContent","setLoading","loading","disabled","setBtnText","text","stopPolling","clearInterval","pollStatus","async","timeout","data","Repository","pollConnectionStatus","apiUrl","status","site_key","site_secret","siteKey","siteSecret","saving","saveCredentials","saveUrl","sesskey","success","reconnectBtn","classList","remove","add","setTimeout","ConnectionStatus","testConnection","saveFailed","err","credentialsRetrieved","tokenExpired","startConnection","hideStatus","initializing","initConnection","connectUrl","token","connectPageUrl","frontendUrl","encodeURIComponent","window","open","popupBlocked","waitingBtn","waiting","setInterval","initFailed","cfg","results","key","component","loadStrings","addEventListener"],"mappings":"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"}