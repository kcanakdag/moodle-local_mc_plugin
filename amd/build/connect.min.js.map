{"version":3,"file":"connect.min.js","sources":["../src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n *\n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n *\n * Uses data-* attributes from connect_button.mustache template.\n *\n * @module     local_mc_plugin/connect\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'local_mc_plugin/local/admin/selectors',\n    'local_mc_plugin/local/admin/repository',\n    'local_mc_plugin/local/admin/connection_status',\n    'core/str'\n], function(Selectors, Repository, ConnectionStatus, Str) {\n    \"use strict\";\n\n    const POLL_INTERVAL = 3000; // 3 seconds\n    const MAX_POLL_ATTEMPTS = 60; // 3 minutes total\n\n    /** @type {Object} Configuration */\n    let config = {};\n\n    /** @type {Object} Language strings */\n    let strings = {};\n\n    /** @type {number|null} Poll timer ID */\n    let pollTimer = null;\n\n    /** @type {number} Poll attempt counter */\n    let pollAttempts = 0;\n\n    /** @type {string|null} Current connection token */\n    let currentToken = null;\n\n    /** @type {boolean} Whether currently connected */\n    let isConnected = false;\n\n    /** @type {HTMLElement|null} Connect button */\n    let connectBtn = null;\n\n    /** @type {HTMLElement|null} Button text element */\n    let btnText = null;\n\n    /** @type {HTMLElement|null} Button spinner element */\n    let btnSpinner = null;\n\n    /** @type {HTMLElement|null} Status div element */\n    let statusDiv = null;\n\n    /** @type {HTMLElement|null} Status icon element */\n    let statusIcon = null;\n\n    /** @type {HTMLElement|null} Status text element */\n    let statusText = null;\n\n\n    /**\n     * Load language strings.\n     *\n     * @returns {Promise<void>}\n     */\n    const loadStrings = async() => {\n        const results = await Str.get_strings([\n            {key: 'connect_initializing', component: 'local_mc_plugin'},\n            {key: 'connect_waiting', component: 'local_mc_plugin'},\n            {key: 'connect_waiting_btn', component: 'local_mc_plugin'},\n            {key: 'connect_saving', component: 'local_mc_plugin'},\n            {key: 'connect_success', component: 'local_mc_plugin'},\n            {key: 'connect_popup_blocked', component: 'local_mc_plugin'},\n            {key: 'connect_init_failed', component: 'local_mc_plugin'},\n            {key: 'connect_timeout', component: 'local_mc_plugin'},\n            {key: 'connect_token_expired', component: 'local_mc_plugin'},\n            {key: 'connect_credentials_retrieved', component: 'local_mc_plugin'},\n            {key: 'connect_save_failed', component: 'local_mc_plugin'},\n            {key: 'connect_button', component: 'local_mc_plugin'},\n            {key: 'reconnect_button', component: 'local_mc_plugin'},\n        ]);\n\n        strings = {\n            initializing: results[0],\n            waiting: results[1],\n            waitingBtn: results[2],\n            saving: results[3],\n            success: results[4],\n            popupBlocked: results[5],\n            initFailed: results[6],\n            timeout: results[7],\n            tokenExpired: results[8],\n            credentialsRetrieved: results[9],\n            saveFailed: results[10],\n            connectBtn: results[11],\n            reconnectBtn: results[12],\n        };\n    };\n\n    /**\n     * Find DOM elements using data-* attribute selectors.\n     */\n    const findElements = () => {\n        // Try data-* attribute selectors first (from template)\n        const container = document.querySelector(Selectors.connect.container);\n\n        if (container) {\n            connectBtn = container.querySelector(Selectors.connect.button);\n            btnText = container.querySelector(Selectors.connect.buttonText);\n            btnSpinner = container.querySelector(Selectors.connect.buttonSpinner);\n            statusDiv = container.querySelector(Selectors.connect.statusDiv);\n            statusIcon = container.querySelector(Selectors.connect.statusIcon);\n            statusText = container.querySelector(Selectors.connect.statusText);\n        } else {\n            // Fallback to legacy ID-based selectors\n            connectBtn = document.querySelector(Selectors.connect.legacyButton);\n            btnText = document.querySelector(Selectors.connect.legacyButtonText);\n            btnSpinner = document.querySelector(Selectors.connect.legacyButtonSpinner);\n            statusDiv = document.querySelector(Selectors.connect.legacyStatusDiv);\n            statusIcon = document.querySelector(Selectors.connect.legacyStatusIcon);\n            statusText = document.querySelector(Selectors.connect.legacyStatusText);\n        }\n    };\n\n    /**\n     * Show status message.\n     *\n     * @param {string} type Status type: 'waiting', 'success', 'error'\n     * @param {string} message Status message\n     */\n    const showStatus = (type, message) => {\n        if (!statusDiv) {\n            return;\n        }\n\n        // Show the status div\n        statusDiv.classList.remove('d-none');\n        statusDiv.style.display = 'block';\n\n        // Remove previous alert classes\n        statusDiv.classList.remove('alert-warning', 'alert-success', 'alert-danger');\n\n        if (type === 'waiting') {\n            statusDiv.classList.add('alert-warning');\n            if (statusIcon) {\n                statusIcon.innerHTML = '<span class=\"spinner-border spinner-border-sm mr-2\"></span>';\n            }\n        } else if (type === 'success') {\n            statusDiv.classList.add('alert-success');\n            if (statusIcon) {\n                statusIcon.innerHTML = '✓ ';\n            }\n        } else if (type === 'error') {\n            statusDiv.classList.add('alert-danger');\n            if (statusIcon) {\n                statusIcon.innerHTML = '✗ ';\n            }\n        }\n\n        if (statusText) {\n            statusText.textContent = message;\n        }\n    };\n\n    /**\n     * Hide status message.\n     */\n    const hideStatus = () => {\n        if (statusDiv) {\n            statusDiv.classList.add('d-none');\n            statusDiv.style.display = 'none';\n        }\n    };\n\n    /**\n     * Set loading state.\n     *\n     * @param {boolean} loading Whether loading\n     */\n    const setLoading = (loading) => {\n        if (connectBtn) {\n            connectBtn.disabled = loading;\n        }\n        if (btnSpinner) {\n            if (loading) {\n                btnSpinner.classList.remove('d-none');\n            } else {\n                btnSpinner.classList.add('d-none');\n            }\n        }\n    };\n\n    /**\n     * Set button text.\n     *\n     * @param {string} text Button text\n     */\n    const setBtnText = (text) => {\n        if (btnText) {\n            btnText.textContent = text;\n        }\n    };\n\n    /**\n     * Stop polling.\n     */\n    const stopPolling = () => {\n        if (pollTimer) {\n            clearInterval(pollTimer);\n            pollTimer = null;\n        }\n    };\n\n    /**\n     * Save credentials after successful connection.\n     *\n     * @param {string} siteKey Site key\n     * @param {string} siteSecret Site secret\n     */\n    const saveCredentials = async(siteKey, siteSecret) => {\n        showStatus('waiting', strings.saving);\n\n        try {\n            const data = await Repository.saveCredentials(config.saveUrl, config.sesskey, siteKey, siteSecret);\n\n            setLoading(false);\n\n            if (data.success) {\n                showStatus('success', strings.success);\n                setBtnText(strings.reconnectBtn);\n\n                if (connectBtn) {\n                    connectBtn.classList.remove('btn-primary');\n                    connectBtn.classList.add('btn-outline-primary');\n                }\n\n                isConnected = true;\n\n                // Refresh connection status\n                setTimeout(() => {\n                    ConnectionStatus.testConnection();\n                }, 500);\n            } else {\n                showStatus('error', data.message || strings.saveFailed);\n            }\n        } catch (err) {\n            setLoading(false);\n            showStatus('error', `${strings.saveFailed}: ${err.message}`);\n        }\n    };\n\n    /**\n     * Poll for connection status.\n     */\n    const pollStatus = async() => {\n        pollAttempts++;\n\n        if (pollAttempts > MAX_POLL_ATTEMPTS) {\n            stopPolling();\n            setLoading(false);\n            showStatus('error', strings.timeout);\n            return;\n        }\n\n        try {\n            const data = await Repository.pollConnectionStatus(config.apiUrl, currentToken);\n\n            if (data.status === 'completed') {\n                stopPolling();\n\n                if (data.site_key && data.site_secret) {\n                    saveCredentials(data.site_key, data.site_secret);\n                } else {\n                    setLoading(false);\n                    showStatus('error', strings.credentialsRetrieved);\n                }\n            } else if (data.status === 'expired') {\n                stopPolling();\n                setLoading(false);\n                showStatus('error', strings.tokenExpired);\n            }\n            // If pending, continue polling\n        } catch (e) {\n            // Network error, but continue polling silently\n        }\n    };\n\n    /**\n     * Get the appropriate button text based on connection state.\n     *\n     * @returns {string} Button text\n     */\n    const getButtonText = () => {\n        return isConnected ? strings.reconnectBtn : strings.connectBtn;\n    };\n\n    /**\n     * Reset button state after connection attempt.\n     */\n    const resetButtonState = () => {\n        setLoading(false);\n        setBtnText(getButtonText());\n    };\n\n    /**\n     * Handle successful token retrieval and open connection window.\n     *\n     * @param {Object} data Response data with token\n     */\n    const handleTokenSuccess = (data) => {\n        currentToken = data.token;\n\n        // Open MoodleConnect in a new tab.\n        const connectPageUrl = `${config.frontendUrl}/connect?token=${encodeURIComponent(data.token)}`;\n        const connectWindow = window.open(connectPageUrl, '_blank');\n\n        if (!connectWindow) {\n            resetButtonState();\n            showStatus('error', strings.popupBlocked);\n            return;\n        }\n\n        setBtnText(strings.waitingBtn);\n        showStatus('waiting', strings.waiting);\n\n        // Start polling.\n        pollTimer = setInterval(pollStatus, POLL_INTERVAL);\n    };\n\n    /**\n     * Start the connection flow.\n     */\n    const startConnection = async() => {\n        hideStatus();\n        setLoading(true);\n        setBtnText(strings.initializing);\n        pollAttempts = 0;\n\n        try {\n            const data = await Repository.initConnection(config.connectUrl, config.sesskey);\n\n            if (data.success && data.token) {\n                handleTokenSuccess(data);\n            } else {\n                resetButtonState();\n                showStatus('error', data.message || strings.initFailed);\n            }\n        } catch (err) {\n            resetButtonState();\n            showStatus('error', `${strings.initFailed}: ${err.message}`);\n        }\n    };\n\n    /**\n     * Get config value from button data attribute or fallback config.\n     *\n     * @param {string} dataAttr Data attribute name (lowercase)\n     * @param {string} cfgKey Config key name\n     * @param {Object|null} cfg Fallback config object\n     * @returns {string} Config value\n     */\n    const getConfigValue = (dataAttr, cfgKey, cfg) => {\n        if (connectBtn && connectBtn.dataset[dataAttr]) {\n            return connectBtn.dataset[dataAttr];\n        }\n        if (cfg && cfg[cfgKey]) {\n            return cfg[cfgKey];\n        }\n        return '';\n    };\n\n    /**\n     * Build configuration from button data attributes or fallback config.\n     *\n     * @param {Object|null} cfg Fallback config object\n     * @returns {Object} Configuration object\n     */\n    const buildConfig = (cfg) => {\n        return {\n            connectUrl: getConfigValue('connecturl', 'connectUrl', cfg),\n            saveUrl: getConfigValue('saveurl', 'saveUrl', cfg),\n            apiUrl: getConfigValue('apiurl', 'apiUrl', cfg),\n            frontendUrl: getConfigValue('frontendurl', 'frontendUrl', cfg),\n            sesskey: getConfigValue('sesskey', 'sesskey', cfg),\n        };\n    };\n\n    return {\n        /**\n         * Initialize the connect module.\n         *\n         * @param {Object} [cfg] Optional configuration object\n         */\n        init: async function(cfg) {\n            cfg = cfg || null;\n            await loadStrings();\n            findElements();\n\n            config = buildConfig(cfg);\n\n            if (connectBtn) {\n                isConnected = connectBtn.classList.contains('btn-outline-primary') || Boolean(cfg && cfg.isConnected);\n                connectBtn.addEventListener('click', startConnection);\n            } else if (cfg) {\n                isConnected = Boolean(cfg.isConnected);\n            }\n        }\n    };\n});\n"],"names":["define","Selectors","Repository","ConnectionStatus","Str","config","strings","pollTimer","pollAttempts","currentToken","isConnected","connectBtn","btnText","btnSpinner","statusDiv","statusIcon","statusText","showStatus","type","message","classList","remove","style","display","add","innerHTML","textContent","setLoading","loading","disabled","setBtnText","text","stopPolling","clearInterval","pollStatus","async","timeout","data","pollConnectionStatus","apiUrl","status","site_key","site_secret","siteKey","siteSecret","saving","saveCredentials","saveUrl","sesskey","success","reconnectBtn","setTimeout","testConnection","saveFailed","err","credentialsRetrieved","tokenExpired","e","resetButtonState","startConnection","initializing","initConnection","connectUrl","token","connectPageUrl","frontendUrl","encodeURIComponent","window","open","popupBlocked","waitingBtn","waiting","setInterval","handleTokenSuccess","initFailed","getConfigValue","dataAttr","cfgKey","cfg","dataset","init","results","get_strings","key","component","loadStrings","container","document","querySelector","connect","button","buttonText","buttonSpinner","legacyButton","legacyButtonText","legacyButtonSpinner","legacyStatusDiv","legacyStatusIcon","legacyStatusText","findElements","buildConfig","contains","Boolean","addEventListener"],"mappings":"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"}