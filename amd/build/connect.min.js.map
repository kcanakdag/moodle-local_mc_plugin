{"version":3,"file":"connect.min.js","sources":["../src/connect.js"],"sourcesContent":["/**\n * MoodleConnect OAuth-style connection flow.\n * \n * This module handles:\n * - Opening the MoodleConnect tab with connection token\n * - Polling for connection completion\n * - Storing credentials on success\n * \n * @module     local_mc_plugin/connect\n * @package    local_mc_plugin\n */\n\ndefine(['jquery'], function($) {\n    \n    var POLL_INTERVAL = 3000; // 3 seconds\n    var MAX_POLL_ATTEMPTS = 60; // 3 minutes total\n    \n    var pollTimer = null;\n    var pollAttempts = 0;\n    var currentToken = null;\n    var connectWindow = null;\n    \n    /**\n     * Get the MoodleConnect frontend URL from the API URL.\n     * Converts https://moodleconnect.com/api to https://moodleconnect.com\n     * \n     * @param {string} apiUrl The API URL\n     * @return {string} The frontend URL\n     */\n    function getFrontendUrl(apiUrl) {\n        // Remove /api suffix to get frontend URL\n        return apiUrl.replace(/\\/api\\/?$/, '');\n    }\n    \n    /**\n     * Initialize the connection flow.\n     * \n     * @param {Object} config Configuration object\n     * @param {string} config.connectUrl URL to connect.php AJAX endpoint\n     * @param {string} config.statusUrl URL to check connection status\n     * @param {string} config.saveUrl URL to save credentials\n     * @param {string} config.apiUrl MoodleConnect API URL\n     * @param {string} config.sesskey Moodle session key\n     * @param {Function} config.onStatusChange Callback for status changes\n     * @param {Function} config.onSuccess Callback for successful connection\n     * @param {Function} config.onError Callback for errors\n     */\n    function init(config) {\n        return {\n            startConnection: function() {\n                startConnection(config);\n            },\n            stopPolling: stopPolling\n        };\n    }\n    \n    /**\n     * Start the connection flow.\n     * \n     * @param {Object} config Configuration object\n     */\n    function startConnection(config) {\n        // Reset state\n        stopPolling();\n        pollAttempts = 0;\n        \n        config.onStatusChange('initializing', M.util.get_string('connect_initializing', 'local_mc_plugin'));\n        \n        // Request a connection token from our backend\n        $.ajax({\n            url: config.connectUrl,\n            method: 'POST',\n            data: {\n                action: 'init',\n                sesskey: config.sesskey\n            },\n            dataType: 'json'\n        }).done(function(response) {\n            if (response.success && response.token) {\n                currentToken = response.token;\n                \n                // Open MoodleConnect in a new tab\n                var frontendUrl = getFrontendUrl(config.apiUrl);\n                var connectPageUrl = frontendUrl + '/connect?token=' + encodeURIComponent(response.token);\n                \n                connectWindow = window.open(connectPageUrl, '_blank');\n                \n                if (!connectWindow) {\n                    config.onError(M.util.get_string('connect_popup_blocked', 'local_mc_plugin'));\n                    return;\n                }\n                \n                config.onStatusChange('waiting', M.util.get_string('connect_waiting', 'local_mc_plugin'));\n                \n                // Start polling for completion\n                startPolling(config);\n            } else {\n                config.onError(response.message || M.util.get_string('connect_init_failed', 'local_mc_plugin'));\n            }\n        }).fail(function(xhr, status, error) {\n            config.onError(M.util.get_string('connect_init_failed', 'local_mc_plugin') + ': ' + error);\n        });\n    }\n    \n    /**\n     * Start polling for connection completion.\n     * \n     * @param {Object} config Configuration object\n     */\n    function startPolling(config) {\n        pollTimer = setInterval(function() {\n            pollAttempts++;\n            \n            if (pollAttempts > MAX_POLL_ATTEMPTS) {\n                stopPolling();\n                config.onError(M.util.get_string('connect_timeout', 'local_mc_plugin'));\n                return;\n            }\n            \n            // Poll the MoodleConnect API for status\n            $.ajax({\n                url: config.apiUrl + '/connect/status',\n                method: 'GET',\n                data: {\n                    token: currentToken\n                },\n                dataType: 'json'\n            }).done(function(response) {\n                if (response.status === 'completed') {\n                    stopPolling();\n                    \n                    if (response.site_key && response.site_secret) {\n                        // Save credentials\n                        saveCredentials(config, response.site_key, response.site_secret);\n                    } else {\n                        // Credentials already retrieved\n                        config.onError(M.util.get_string('connect_credentials_retrieved', 'local_mc_plugin'));\n                    }\n                } else if (response.status === 'expired') {\n                    stopPolling();\n                    config.onError(M.util.get_string('connect_token_expired', 'local_mc_plugin'));\n                } else if (response.status === 'pending') {\n                    // Still waiting, continue polling\n                    config.onStatusChange('waiting', M.util.get_string('connect_waiting', 'local_mc_plugin'));\n                }\n            }).fail(function(xhr, status, error) {\n                // Network error, but don't stop polling yet\n                console.warn('Poll failed:', error);\n            });\n        }, POLL_INTERVAL);\n    }\n    \n    /**\n     * Stop the polling timer.\n     */\n    function stopPolling() {\n        if (pollTimer) {\n            clearInterval(pollTimer);\n            pollTimer = null;\n        }\n    }\n    \n    /**\n     * Save credentials to Moodle settings.\n     * \n     * @param {Object} config Configuration object\n     * @param {string} siteKey The site key\n     * @param {string} siteSecret The site secret\n     */\n    function saveCredentials(config, siteKey, siteSecret) {\n        config.onStatusChange('saving', M.util.get_string('connect_saving', 'local_mc_plugin'));\n        \n        $.ajax({\n            url: config.saveUrl,\n            method: 'POST',\n            data: {\n                action: 'save',\n                sesskey: config.sesskey,\n                site_key: siteKey,\n                site_secret: siteSecret\n            },\n            dataType: 'json'\n        }).done(function(response) {\n            if (response.success) {\n                config.onSuccess(siteKey);\n            } else {\n                config.onError(response.message || M.util.get_string('connect_save_failed', 'local_mc_plugin'));\n            }\n        }).fail(function(xhr, status, error) {\n            config.onError(M.util.get_string('connect_save_failed', 'local_mc_plugin') + ': ' + error);\n        });\n    }\n    \n    return {\n        init: init\n    };\n});\n"],"names":[],"mappings":"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"}