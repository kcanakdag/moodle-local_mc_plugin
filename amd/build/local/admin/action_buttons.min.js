/**
 * Action buttons module for the admin settings page.
 *
 * Handles the Save & Sync button functionality using Mustache templates
 * for result message display.
 *
 * @module     local_mc_plugin/local/admin/action_buttons
 * @copyright  2025 Kerem Can Akdag
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["local_mc_plugin/local/admin/selectors","local_mc_plugin/local/admin/repository","local_mc_plugin/local/admin/connection_status","local_mc_plugin/local/admin/templates","core/str"],function(e,t,n,s,c){"use strict";let a={},l="",i=null,o=null,r=null,u=null,y=null;const d=async(e,t)=>{if(!o)return;const n=s.buildActionResultContext(e,t);await s.renderActionResult(o,n)},g=e=>{r&&(r.disabled=e),u&&(e?u.classList.remove("d-none"):u.classList.add("d-none"))},m=e=>{y&&(y.textContent=e)},_=async()=>{o&&(o.innerHTML=""),g(!0);const s=await c.get_string("btn_saving","local_mc_plugin");m(s);try{const s=(()=>{const t={},n=document.querySelector(e.inputs.siteKey);n&&n.value&&(t.siteKey=n.value);const s=document.querySelector(e.inputs.siteSecret);s&&s.value&&(t.siteSecret=s.value);const c=document.querySelector(e.inputs.monitoredEvents);c&&(t.monitoredEvents=c.value);const a=document.querySelector(e.inputs.debugMode);return a&&(t.debugMode=a.checked?1:0),t})(),i=await t.saveSettings(a.ajaxSaveUrl,a.sesskey,s);if(!i.success)return g(!1),m(l),void await d(!1,i.message||"Failed to save settings");const o=await c.get_string("btn_syncing","local_mc_plugin");m(o);const r=await t.syncEvents(a.syncUrl,a.sesskey);if(g(!1),m(l),r.success){const e=await c.get_string("sync_success","local_mc_plugin",r.event_count||0);await d(!0,e),n.testConnection()}else{const e=await c.get_string("sync_failed","local_mc_plugin",r.message);await d(!1,e),n.updateStatusWithError(r.message)}}catch(e){g(!1),m(l),await d(!1,`Error: ${e.message}`)}};return{init:async function(t){t=t||null,i=document.querySelector(e.actions.container),i?(a={syncUrl:i.dataset.syncurl||t&&t.syncUrl||"",ajaxSaveUrl:i.dataset.ajaxsaveurl||t&&t.ajaxSaveUrl||"",sesskey:i.dataset.sesskey||t&&t.sesskey||""},o=i.querySelector(e.actions.resultDiv),r=i.querySelector(e.actions.primaryBtn),u=i.querySelector(e.actions.btnSpinner),y=i.querySelector(e.actions.btnText)):t&&(a=t,o=document.querySelector(e.actions.legacyResultDiv),r=document.querySelector(e.actions.legacyPrimaryBtn),u=document.querySelector(e.actions.legacyBtnSpinner),y=document.querySelector(e.actions.legacyBtnText)),l=await c.get_string("btn_save_sync","local_mc_plugin"),r&&r.addEventListener("click",_)}}});