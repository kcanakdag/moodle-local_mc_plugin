{"version":3,"names":["define","Selectors","Repository","ConnectionStatus","TemplateHelper","Str","config","btnLabel","container","resultDiv","primaryBtn","btnSpinner","btnTextEl","showResult","async","success","message","context","buildActionResultContext","renderActionResult","setLoading","loading","disabled","classList","remove","add","setBtnText","text","textContent","handleSaveSync","innerHTML","savingText","get_string","values","siteKeyInput","document","querySelector","inputs","siteKey","value","siteSecretInput","siteSecret","eventsInput","monitoredEvents","debugInput","debugMode","checked","getFormValues","saveResult","saveSettings","ajaxSaveUrl","sesskey","syncingText","syncResult","syncEvents","syncUrl","successMsg","event_count","testConnection","failMsg","updateStatusWithError","err","init","cfg","actions","dataset","syncurl","ajaxsaveurl","btnText","legacyResultDiv","legacyPrimaryBtn","legacyBtnSpinner","legacyBtnText","addEventListener"],"sources":["amd/src/local/admin/action_buttons.js"],"sourcesContent":["/**\n * Action buttons module for the admin settings page.\n *\n * Handles the Save & Sync button functionality using Mustache templates\n * for result message display.\n *\n * @module     local_mc_plugin/local/admin/action_buttons\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'local_mc_plugin/local/admin/selectors',\n    'local_mc_plugin/local/admin/repository',\n    'local_mc_plugin/local/admin/connection_status',\n    'local_mc_plugin/local/admin/templates',\n    'core/str'\n], function(Selectors, Repository, ConnectionStatus, TemplateHelper, Str) {\n    \"use strict\";\n\n    /** @type {Object} Configuration */\n    let config = {};\n\n    /** @type {string} Button label */\n    let btnLabel = '';\n\n    /** @type {HTMLElement|null} Action buttons container */\n    let container = null;\n\n    /** @type {HTMLElement|null} Result message container */\n    let resultDiv = null;\n\n    /** @type {HTMLElement|null} Primary button */\n    let primaryBtn = null;\n\n    /** @type {HTMLElement|null} Button spinner */\n    let btnSpinner = null;\n\n    /** @type {HTMLElement|null} Button text element */\n    let btnTextEl = null;\n\n    /**\n     * Show result message using template rendering.\n     *\n     * @param {boolean} success Whether successful\n     * @param {string} message The message to display\n     */\n    const showResult = async(success, message) => {\n        if (!resultDiv) {\n            return;\n        }\n\n        const context = TemplateHelper.buildActionResultContext(success, message);\n        await TemplateHelper.renderActionResult(resultDiv, context);\n    };\n\n    /**\n     * Clear the result message.\n     */\n    const clearResult = () => {\n        if (resultDiv) {\n            resultDiv.innerHTML = '';\n        }\n    };\n\n\n    /**\n     * Set loading state on button.\n     *\n     * @param {boolean} loading Whether loading\n     */\n    const setLoading = (loading) => {\n        if (primaryBtn) {\n            primaryBtn.disabled = loading;\n        }\n        if (btnSpinner) {\n            if (loading) {\n                btnSpinner.classList.remove('d-none');\n            } else {\n                btnSpinner.classList.add('d-none');\n            }\n        }\n    };\n\n    /**\n     * Set button text.\n     *\n     * @param {string} text The text to display\n     */\n    const setBtnText = (text) => {\n        if (btnTextEl) {\n            btnTextEl.textContent = text;\n        }\n    };\n\n    /**\n     * Get form values for saving.\n     *\n     * @returns {Object} Form values\n     */\n    const getFormValues = () => {\n        const values = {};\n\n        const siteKeyInput = document.querySelector(Selectors.inputs.siteKey);\n        if (siteKeyInput && siteKeyInput.value) {\n            values.siteKey = siteKeyInput.value;\n        }\n\n        const siteSecretInput = document.querySelector(Selectors.inputs.siteSecret);\n        if (siteSecretInput && siteSecretInput.value) {\n            values.siteSecret = siteSecretInput.value;\n        }\n\n        const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n        if (eventsInput) {\n            values.monitoredEvents = eventsInput.value;\n        }\n\n        const debugInput = document.querySelector(Selectors.inputs.debugMode);\n        if (debugInput) {\n            values.debugMode = debugInput.checked ? 1 : 0;\n        }\n\n        return values;\n    };\n\n    /**\n     * Handle the Save & Sync button click.\n     */\n    const handleSaveSync = async() => {\n        clearResult();\n        setLoading(true);\n\n        const savingText = await Str.get_string('btn_saving', 'local_mc_plugin');\n        setBtnText(savingText);\n\n        try {\n            // Save settings first\n            const values = getFormValues();\n            const saveResult = await Repository.saveSettings(config.ajaxSaveUrl, config.sesskey, values);\n\n            if (!saveResult.success) {\n                setLoading(false);\n                setBtnText(btnLabel);\n                await showResult(false, saveResult.message || 'Failed to save settings');\n                return;\n            }\n\n            // Then sync events\n            const syncingText = await Str.get_string('btn_syncing', 'local_mc_plugin');\n            setBtnText(syncingText);\n            const syncResult = await Repository.syncEvents(config.syncUrl, config.sesskey);\n\n            setLoading(false);\n            setBtnText(btnLabel);\n\n            if (syncResult.success) {\n                const successMsg = await Str.get_string('sync_success', 'local_mc_plugin', syncResult.event_count || 0);\n                await showResult(true, successMsg);\n                ConnectionStatus.testConnection();\n            } else {\n                const failMsg = await Str.get_string('sync_failed', 'local_mc_plugin', syncResult.message);\n                await showResult(false, failMsg);\n                ConnectionStatus.updateStatusWithError(syncResult.message);\n            }\n        } catch (err) {\n            setLoading(false);\n            setBtnText(btnLabel);\n            await showResult(false, `Error: ${err.message}`);\n        }\n    };\n\n    return {\n        /**\n         * Initialize the action buttons module.\n         *\n         * @param {Object} [cfg] Optional configuration object\n         */\n        init: async function(cfg) {\n            cfg = cfg || null;\n            // Find the action buttons container\n            container = document.querySelector(Selectors.actions.container);\n\n            if (container) {\n                // Read config from data attributes\n                config = {\n                    syncUrl: container.dataset.syncurl || (cfg && cfg.syncUrl) || '',\n                    ajaxSaveUrl: container.dataset.ajaxsaveurl || (cfg && cfg.ajaxSaveUrl) || '',\n                    sesskey: container.dataset.sesskey || (cfg && cfg.sesskey) || '',\n                };\n\n                // Find elements within container\n                resultDiv = container.querySelector(Selectors.actions.resultDiv);\n                primaryBtn = container.querySelector(Selectors.actions.primaryBtn);\n                btnSpinner = container.querySelector(Selectors.actions.btnSpinner);\n                btnTextEl = container.querySelector(Selectors.actions.btnText);\n            } else if (cfg) {\n                // Fallback to passed config and legacy selectors (backward compatibility)\n                config = cfg;\n                resultDiv = document.querySelector(Selectors.actions.legacyResultDiv);\n                primaryBtn = document.querySelector(Selectors.actions.legacyPrimaryBtn);\n                btnSpinner = document.querySelector(Selectors.actions.legacyBtnSpinner);\n                btnTextEl = document.querySelector(Selectors.actions.legacyBtnText);\n            }\n\n            // Load button label string\n            btnLabel = await Str.get_string('btn_save_sync', 'local_mc_plugin');\n\n            if (primaryBtn) {\n                primaryBtn.addEventListener('click', handleSaveSync);\n            }\n        }\n    };\n});\n"],"mappings":"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","ignoreList":[]}