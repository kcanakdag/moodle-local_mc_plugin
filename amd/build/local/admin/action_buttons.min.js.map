{"version":3,"file":"action_buttons.min.js","sources":["../../../src/local/admin/action_buttons.js"],"sourcesContent":["/**\n * Action buttons module for the admin settings page.\n *\n * Handles the Save & Sync button functionality.\n *\n * @module     local_mc_plugin/local/admin/action_buttons\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './selectors';\nimport * as Repository from './repository';\nimport * as ConnectionStatus from './connection_status';\nimport {get_string as getString} from 'core/str';\n\n/** @type {Object} Configuration */\nlet config = {};\n\n/** @type {string} Button label */\nlet btnLabel = '';\n\n/**\n * Show result message.\n *\n * @param {boolean} success Whether successful\n * @param {string} message The message to display\n */\nconst showResult = (success, message) => {\n    const resultDiv = document.querySelector(Selectors.actions.resultDiv);\n    if (!resultDiv) {\n        return;\n    }\n\n    resultDiv.style.display = 'block';\n    resultDiv.style.background = success ? '#d4edda' : '#f8d7da';\n    resultDiv.style.color = success ? '#155724' : '#721c24';\n    resultDiv.innerHTML = (success ? '✓ ' : '✗ ') + message;\n};\n\n/**\n * Set loading state on button.\n *\n * @param {boolean} loading Whether loading\n */\nconst setLoading = (loading) => {\n    const primaryBtn = document.querySelector(Selectors.actions.primaryBtn);\n    const btnSpinner = document.querySelector(Selectors.actions.btnSpinner);\n\n    if (primaryBtn) {\n        primaryBtn.disabled = loading;\n    }\n    if (btnSpinner) {\n        btnSpinner.style.display = loading ? 'inline-block' : 'none';\n    }\n};\n\n/**\n * Set button text.\n *\n * @param {string} text The text to display\n */\nconst setBtnText = (text) => {\n    const btnTextEl = document.querySelector(Selectors.actions.btnText);\n    if (btnTextEl) {\n        btnTextEl.textContent = text;\n    }\n};\n\n/**\n * Get form values for saving.\n *\n * @returns {Object} Form values\n */\nconst getFormValues = () => {\n    const values = {};\n\n    const siteKeyInput = document.querySelector(Selectors.inputs.siteKey);\n    if (siteKeyInput && siteKeyInput.value) {\n        values.site_key = siteKeyInput.value;\n    }\n\n    const siteSecretInput = document.querySelector(Selectors.inputs.siteSecret);\n    if (siteSecretInput && siteSecretInput.value) {\n        values.site_secret = siteSecretInput.value;\n    }\n\n    const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n    if (eventsInput) {\n        values.monitored_events = eventsInput.value;\n    }\n\n    const debugInput = document.querySelector(Selectors.inputs.debugMode);\n    if (debugInput) {\n        values.debug_mode = debugInput.checked ? 1 : 0;\n    }\n\n    return values;\n};\n\n/**\n * Handle the Save & Sync button click.\n */\nconst handleSaveSync = async() => {\n    const resultDiv = document.querySelector(Selectors.actions.resultDiv);\n    if (resultDiv) {\n        resultDiv.style.display = 'none';\n    }\n\n    setLoading(true);\n    setBtnText('Saving...');\n\n    try {\n        // Save settings first\n        const values = getFormValues();\n        const saveResult = await Repository.saveSettings(config.ajaxSaveUrl, config.sesskey, values);\n\n        if (!saveResult.success) {\n            setLoading(false);\n            setBtnText(btnLabel);\n            showResult(false, saveResult.message || 'Failed to save settings');\n            return;\n        }\n\n        // Then sync events\n        setBtnText('Syncing...');\n        const syncResult = await Repository.syncEvents(config.syncUrl, config.sesskey);\n\n        setLoading(false);\n        setBtnText(btnLabel);\n\n        if (syncResult.success) {\n            showResult(true, `Settings saved. Synced ${syncResult.event_count || 0} event(s) to MoodleConnect`);\n            ConnectionStatus.testConnection();\n        } else {\n            showResult(false, `Settings saved, but sync failed: ${syncResult.message}`);\n            ConnectionStatus.updateStatusWithError(syncResult.message);\n        }\n    } catch (err) {\n        setLoading(false);\n        setBtnText(btnLabel);\n        showResult(false, `Error: ${err.message}`);\n    }\n};\n\n/**\n * Initialize the action buttons module.\n *\n * @param {Object} cfg Configuration object\n * @param {string} cfg.syncUrl URL to sync_schema.php\n * @param {string} cfg.ajaxSaveUrl URL to ajax_save.php\n * @param {string} cfg.sesskey Moodle session key\n */\nexport const init = async(cfg) => {\n    config = cfg;\n\n    // Load button label string\n    btnLabel = await getString('btn_save_sync', 'local_mc_plugin');\n\n    const primaryBtn = document.querySelector(Selectors.actions.primaryBtn);\n    if (primaryBtn) {\n        primaryBtn.addEventListener('click', handleSaveSync);\n    }\n};\n"],"names":["config","btnLabel","showResult","success","message","resultDiv","document","querySelector","Selectors","actions","style","display","background","color","innerHTML","setLoading","loading","primaryBtn","btnSpinner","disabled","setBtnText","text","btnTextEl","btnText","textContent","handleSaveSync","async","values","siteKeyInput","inputs","siteKey","value","site_key","siteSecretInput","siteSecret","site_secret","eventsInput","monitoredEvents","monitored_events","debugInput","debugMode","debug_mode","checked","getFormValues","saveResult","Repository","saveSettings","ajaxSaveUrl","sesskey","syncResult","syncEvents","syncUrl","event_count","ConnectionStatus","testConnection","updateStatusWithError","err","cfg","addEventListener"],"mappings":";;;;;;;;;qrCAgBIA,OAAS,GAGTC,SAAW,SAQTC,WAAa,CAACC,QAASC,iBACnBC,UAAYC,SAASC,cAAcC,mBAAUC,QAAQJ,WACtDA,YAILA,UAAUK,MAAMC,QAAU,QAC1BN,UAAUK,MAAME,WAAaT,QAAU,UAAY,UACnDE,UAAUK,MAAMG,MAAQV,QAAU,UAAY,UAC9CE,UAAUS,WAAaX,QAAU,KAAO,MAAQC,UAQ9CW,WAAcC,gBACVC,WAAaX,SAASC,cAAcC,mBAAUC,QAAQQ,YACtDC,WAAaZ,SAASC,cAAcC,mBAAUC,QAAQS,YAExDD,aACAA,WAAWE,SAAWH,SAEtBE,aACAA,WAAWR,MAAMC,QAAUK,QAAU,eAAiB,SASxDI,WAAcC,aACVC,UAAYhB,SAASC,cAAcC,mBAAUC,QAAQc,SACvDD,YACAA,UAAUE,YAAcH,OAsC1BI,eAAiBC,gBACbrB,UAAYC,SAASC,cAAcC,mBAAUC,QAAQJ,WACvDA,YACAA,UAAUK,MAAMC,QAAU,QAG9BI,YAAW,GACXK,WAAW,uBAIDO,OAxCQ,YACZA,OAAS,GAETC,aAAetB,SAASC,cAAcC,mBAAUqB,OAAOC,SACzDF,cAAgBA,aAAaG,QAC7BJ,OAAOK,SAAWJ,aAAaG,aAG7BE,gBAAkB3B,SAASC,cAAcC,mBAAUqB,OAAOK,YAC5DD,iBAAmBA,gBAAgBF,QACnCJ,OAAOQ,YAAcF,gBAAgBF,aAGnCK,YAAc9B,SAASC,cAAcC,mBAAUqB,OAAOQ,iBACxDD,cACAT,OAAOW,iBAAmBF,YAAYL,aAGpCQ,WAAajC,SAASC,cAAcC,mBAAUqB,OAAOW,kBACvDD,aACAZ,OAAOc,WAAaF,WAAWG,QAAU,EAAI,GAG1Cf,QAiBYgB,GACTC,iBAAmBC,WAAWC,aAAa9C,OAAO+C,YAAa/C,OAAOgD,QAASrB,YAEhFiB,WAAWzC,eACZY,YAAW,GACXK,WAAWnB,eACXC,YAAW,EAAO0C,WAAWxC,SAAW,2BAK5CgB,WAAW,oBACL6B,iBAAmBJ,WAAWK,WAAWlD,OAAOmD,QAASnD,OAAOgD,SAEtEjC,YAAW,GACXK,WAAWnB,UAEPgD,WAAW9C,SACXD,YAAW,mCAAgC+C,WAAWG,aAAe,iCACrEC,iBAAiBC,mBAEjBpD,YAAW,6CAA2C+C,WAAW7C,UACjEiD,iBAAiBE,sBAAsBN,WAAW7C,UAExD,MAAOoD,KACLzC,YAAW,GACXK,WAAWnB,UACXC,YAAW,mBAAiBsD,IAAIpD,0BAYpBsB,MAAAA,MAChB1B,OAASyD,IAGTxD,eAAiB,mBAAU,gBAAiB,yBAEtCgB,WAAaX,SAASC,cAAcC,mBAAUC,QAAQQ,YACxDA,YACAA,WAAWyC,iBAAiB,QAASjC"}