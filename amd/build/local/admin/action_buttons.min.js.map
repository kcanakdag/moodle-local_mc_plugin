{"version":3,"file":"action_buttons.min.js","sources":["../../../src/local/admin/action_buttons.js"],"sourcesContent":["/**\n * Action buttons module for the admin settings page.\n *\n * Handles the Save & Sync button functionality using Mustache templates\n * for result message display.\n *\n * @module     local_mc_plugin/local/admin/action_buttons\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './selectors';\nimport * as Repository from './repository';\nimport * as ConnectionStatus from './connection_status';\nimport * as TemplateHelper from './templates';\nimport {get_string as getString} from 'core/str';\n\n/** @type {Object} Configuration */\nlet config = {};\n\n/** @type {string} Button label */\nlet btnLabel = '';\n\n/** @type {HTMLElement|null} Action buttons container */\nlet container = null;\n\n/** @type {HTMLElement|null} Result message container */\nlet resultDiv = null;\n\n/** @type {HTMLElement|null} Primary button */\nlet primaryBtn = null;\n\n/** @type {HTMLElement|null} Button spinner */\nlet btnSpinner = null;\n\n/** @type {HTMLElement|null} Button text element */\nlet btnTextEl = null;\n\n/**\n * Show result message using template rendering.\n *\n * @param {boolean} success Whether successful\n * @param {string} message The message to display\n */\nconst showResult = async(success, message) => {\n    if (!resultDiv) {\n        return;\n    }\n\n    const context = TemplateHelper.buildActionResultContext(success, message);\n    await TemplateHelper.renderActionResult(resultDiv, context);\n};\n\n/**\n * Clear the result message.\n */\nconst clearResult = () => {\n    if (resultDiv) {\n        resultDiv.innerHTML = '';\n    }\n};\n\n\n/**\n * Set loading state on button.\n *\n * @param {boolean} loading Whether loading\n */\nconst setLoading = (loading) => {\n    if (primaryBtn) {\n        primaryBtn.disabled = loading;\n    }\n    if (btnSpinner) {\n        if (loading) {\n            btnSpinner.classList.remove('d-none');\n        } else {\n            btnSpinner.classList.add('d-none');\n        }\n    }\n};\n\n/**\n * Set button text.\n *\n * @param {string} text The text to display\n */\nconst setBtnText = (text) => {\n    if (btnTextEl) {\n        btnTextEl.textContent = text;\n    }\n};\n\n/**\n * Get form values for saving.\n *\n * @returns {Object} Form values\n */\nconst getFormValues = () => {\n    const values = {};\n\n    const siteKeyInput = document.querySelector(Selectors.inputs.siteKey);\n    if (siteKeyInput && siteKeyInput.value) {\n        values.site_key = siteKeyInput.value;\n    }\n\n    const siteSecretInput = document.querySelector(Selectors.inputs.siteSecret);\n    if (siteSecretInput && siteSecretInput.value) {\n        values.site_secret = siteSecretInput.value;\n    }\n\n    const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n    if (eventsInput) {\n        values.monitored_events = eventsInput.value;\n    }\n\n    const debugInput = document.querySelector(Selectors.inputs.debugMode);\n    if (debugInput) {\n        values.debug_mode = debugInput.checked ? 1 : 0;\n    }\n\n    return values;\n};\n\n/**\n * Handle the Save & Sync button click.\n */\nconst handleSaveSync = async() => {\n    clearResult();\n    setLoading(true);\n\n    const savingText = await getString('btn_saving', 'local_mc_plugin');\n    setBtnText(savingText);\n\n    try {\n        // Save settings first\n        const values = getFormValues();\n        const saveResult = await Repository.saveSettings(config.ajaxSaveUrl, config.sesskey, values);\n\n        if (!saveResult.success) {\n            setLoading(false);\n            setBtnText(btnLabel);\n            await showResult(false, saveResult.message || 'Failed to save settings');\n            return;\n        }\n\n        // Then sync events\n        const syncingText = await getString('btn_syncing', 'local_mc_plugin');\n        setBtnText(syncingText);\n        const syncResult = await Repository.syncEvents(config.syncUrl, config.sesskey);\n\n        setLoading(false);\n        setBtnText(btnLabel);\n\n        if (syncResult.success) {\n            const successMsg = await getString('sync_success', 'local_mc_plugin', syncResult.event_count || 0);\n            await showResult(true, successMsg);\n            ConnectionStatus.testConnection();\n        } else {\n            const failMsg = await getString('sync_failed', 'local_mc_plugin', syncResult.message);\n            await showResult(false, failMsg);\n            ConnectionStatus.updateStatusWithError(syncResult.message);\n        }\n    } catch (err) {\n        setLoading(false);\n        setBtnText(btnLabel);\n        await showResult(false, `Error: ${err.message}`);\n    }\n};\n\n/**\n * Initialize the action buttons module.\n *\n * Reads configuration from data attributes on the container element.\n *\n * @param {Object} [cfg] Optional configuration object (for backward compatibility)\n * @param {string} [cfg.syncUrl] URL to sync_schema.php\n * @param {string} [cfg.ajaxSaveUrl] URL to ajax_save.php\n * @param {string} [cfg.sesskey] Moodle session key\n */\nexport const init = async(cfg = null) => {\n    // Find the action buttons container\n    container = document.querySelector(Selectors.actions.container);\n\n    if (container) {\n        // Read config from data attributes\n        config = {\n            syncUrl: container.dataset.syncurl || (cfg && cfg.syncUrl) || '',\n            ajaxSaveUrl: container.dataset.ajaxsaveurl || (cfg && cfg.ajaxSaveUrl) || '',\n            sesskey: container.dataset.sesskey || (cfg && cfg.sesskey) || '',\n        };\n\n        // Find elements within container\n        resultDiv = container.querySelector(Selectors.actions.resultDiv);\n        primaryBtn = container.querySelector(Selectors.actions.primaryBtn);\n        btnSpinner = container.querySelector(Selectors.actions.btnSpinner);\n        btnTextEl = container.querySelector(Selectors.actions.btnText);\n    } else if (cfg) {\n        // Fallback to passed config and legacy selectors (backward compatibility)\n        config = cfg;\n        resultDiv = document.querySelector(Selectors.actions.legacyResultDiv);\n        primaryBtn = document.querySelector(Selectors.actions.legacyPrimaryBtn);\n        btnSpinner = document.querySelector(Selectors.actions.legacyBtnSpinner);\n        btnTextEl = document.querySelector(Selectors.actions.legacyBtnText);\n    }\n\n    // Load button label string\n    btnLabel = await getString('btn_save_sync', 'local_mc_plugin');\n\n    if (primaryBtn) {\n        primaryBtn.addEventListener('click', handleSaveSync);\n    }\n};\n"],"names":["config","btnLabel","container","resultDiv","primaryBtn","btnSpinner","btnTextEl","showResult","async","success","message","context","TemplateHelper","buildActionResultContext","renderActionResult","setLoading","loading","disabled","classList","remove","add","setBtnText","text","textContent","handleSaveSync","innerHTML","savingText","values","siteKeyInput","document","querySelector","Selectors","inputs","siteKey","value","site_key","siteSecretInput","siteSecret","site_secret","eventsInput","monitoredEvents","monitored_events","debugInput","debugMode","debug_mode","checked","getFormValues","saveResult","Repository","saveSettings","ajaxSaveUrl","sesskey","syncingText","syncResult","syncEvents","syncUrl","successMsg","event_count","ConnectionStatus","testConnection","failMsg","updateStatusWithError","err","cfg","actions","dataset","syncurl","ajaxsaveurl","btnText","legacyResultDiv","legacyPrimaryBtn","legacyBtnSpinner","legacyBtnText","addEventListener"],"mappings":";;;;;;;;;;4uCAkBIA,OAAS,GAGTC,SAAW,GAGXC,UAAY,KAGZC,UAAY,KAGZC,WAAa,KAGbC,WAAa,KAGbC,UAAY,WAQVC,WAAaC,MAAMC,QAASC,eACzBP,uBAICQ,QAAUC,eAAeC,yBAAyBJ,QAASC,eAC3DE,eAAeE,mBAAmBX,UAAWQ,UAkBjDI,WAAcC,UACZZ,aACAA,WAAWa,SAAWD,SAEtBX,aACIW,QACAX,WAAWa,UAAUC,OAAO,UAE5Bd,WAAWa,UAAUE,IAAI,YAU/BC,WAAcC,OACZhB,YACAA,UAAUiB,YAAcD,OAsC1BE,eAAiBhB,UArEfL,YACAA,UAAUsB,UAAY,IAsE1BV,YAAW,SAELW,iBAAmB,mBAAU,aAAc,mBACjDL,WAAWK,sBAIDC,OAtCQ,YACZA,OAAS,GAETC,aAAeC,SAASC,cAAcC,mBAAUC,OAAOC,SACzDL,cAAgBA,aAAaM,QAC7BP,OAAOQ,SAAWP,aAAaM,aAG7BE,gBAAkBP,SAASC,cAAcC,mBAAUC,OAAOK,YAC5DD,iBAAmBA,gBAAgBF,QACnCP,OAAOW,YAAcF,gBAAgBF,aAGnCK,YAAcV,SAASC,cAAcC,mBAAUC,OAAOQ,iBACxDD,cACAZ,OAAOc,iBAAmBF,YAAYL,aAGpCQ,WAAab,SAASC,cAAcC,mBAAUC,OAAOW,kBACvDD,aACAf,OAAOiB,WAAaF,WAAWG,QAAU,EAAI,GAG1ClB,QAeYmB,GACTC,iBAAmBC,WAAWC,aAAajD,OAAOkD,YAAalD,OAAOmD,QAASxB,YAEhFoB,WAAWtC,eACZM,YAAW,GACXM,WAAWpB,qBACLM,YAAW,EAAOwC,WAAWrC,SAAW,iCAK5C0C,kBAAoB,mBAAU,cAAe,mBACnD/B,WAAW+B,mBACLC,iBAAmBL,WAAWM,WAAWtD,OAAOuD,QAASvD,OAAOmD,YAEtEpC,YAAW,GACXM,WAAWpB,UAEPoD,WAAW5C,QAAS,OACd+C,iBAAmB,mBAAU,eAAgB,kBAAmBH,WAAWI,aAAe,SAC1FlD,YAAW,EAAMiD,YACvBE,iBAAiBC,qBACd,OACGC,cAAgB,mBAAU,cAAe,kBAAmBP,WAAW3C,eACvEH,YAAW,EAAOqD,SACxBF,iBAAiBG,sBAAsBR,WAAW3C,UAExD,MAAOoD,KACL/C,YAAW,GACXM,WAAWpB,gBACLM,YAAW,mBAAiBuD,IAAIpD,0BAc1BF,qBAAMuD,2DAAM,KAE5B7D,UAAY2B,SAASC,cAAcC,mBAAUiC,QAAQ9D,WAEjDA,WAEAF,OAAS,CACLuD,QAASrD,UAAU+D,QAAQC,SAAYH,KAAOA,IAAIR,SAAY,GAC9DL,YAAahD,UAAU+D,QAAQE,aAAgBJ,KAAOA,IAAIb,aAAgB,GAC1EC,QAASjD,UAAU+D,QAAQd,SAAYY,KAAOA,IAAIZ,SAAY,IAIlEhD,UAAYD,UAAU4B,cAAcC,mBAAUiC,QAAQ7D,WACtDC,WAAaF,UAAU4B,cAAcC,mBAAUiC,QAAQ5D,YACvDC,WAAaH,UAAU4B,cAAcC,mBAAUiC,QAAQ3D,YACvDC,UAAYJ,UAAU4B,cAAcC,mBAAUiC,QAAQI,UAC/CL,MAEP/D,OAAS+D,IACT5D,UAAY0B,SAASC,cAAcC,mBAAUiC,QAAQK,iBACrDjE,WAAayB,SAASC,cAAcC,mBAAUiC,QAAQM,kBACtDjE,WAAawB,SAASC,cAAcC,mBAAUiC,QAAQO,kBACtDjE,UAAYuB,SAASC,cAAcC,mBAAUiC,QAAQQ,gBAIzDvE,eAAiB,mBAAU,gBAAiB,mBAExCG,YACAA,WAAWqE,iBAAiB,QAASjD"}