{"version":3,"file":"action_buttons.min.js","sources":["../../../src/local/admin/action_buttons.js"],"sourcesContent":["/**\n * Action buttons module for the admin settings page.\n *\n * Handles the Save & Sync button functionality using Mustache templates\n * for result message display.\n *\n * @module     local_mc_plugin/local/admin/action_buttons\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'local_mc_plugin/local/admin/selectors',\n    'local_mc_plugin/local/admin/repository',\n    'local_mc_plugin/local/admin/connection_status',\n    'local_mc_plugin/local/admin/templates',\n    'core/str'\n], function(Selectors, Repository, ConnectionStatus, TemplateHelper, Str) {\n    \"use strict\";\n\n    /** @type {Object} Configuration */\n    let config = {};\n\n    /** @type {string} Button label */\n    let btnLabel = '';\n\n    /** @type {HTMLElement|null} Action buttons container */\n    let container = null;\n\n    /** @type {HTMLElement|null} Result message container */\n    let resultDiv = null;\n\n    /** @type {HTMLElement|null} Primary button */\n    let primaryBtn = null;\n\n    /** @type {HTMLElement|null} Button spinner */\n    let btnSpinner = null;\n\n    /** @type {HTMLElement|null} Button text element */\n    let btnTextEl = null;\n\n    /**\n     * Show result message using template rendering.\n     *\n     * @param {boolean} success Whether successful\n     * @param {string} message The message to display\n     */\n    const showResult = async(success, message) => {\n        if (!resultDiv) {\n            return;\n        }\n\n        const context = TemplateHelper.buildActionResultContext(success, message);\n        await TemplateHelper.renderActionResult(resultDiv, context);\n    };\n\n    /**\n     * Clear the result message.\n     */\n    const clearResult = () => {\n        if (resultDiv) {\n            resultDiv.innerHTML = '';\n        }\n    };\n\n\n    /**\n     * Set loading state on button.\n     *\n     * @param {boolean} loading Whether loading\n     */\n    const setLoading = (loading) => {\n        if (primaryBtn) {\n            primaryBtn.disabled = loading;\n        }\n        if (btnSpinner) {\n            if (loading) {\n                btnSpinner.classList.remove('d-none');\n            } else {\n                btnSpinner.classList.add('d-none');\n            }\n        }\n    };\n\n    /**\n     * Set button text.\n     *\n     * @param {string} text The text to display\n     */\n    const setBtnText = (text) => {\n        if (btnTextEl) {\n            btnTextEl.textContent = text;\n        }\n    };\n\n    /**\n     * Get form values for saving.\n     *\n     * @returns {Object} Form values\n     */\n    const getFormValues = () => {\n        const values = {};\n\n        const siteKeyInput = document.querySelector(Selectors.inputs.siteKey);\n        if (siteKeyInput && siteKeyInput.value) {\n            values.siteKey = siteKeyInput.value;\n        }\n\n        const siteSecretInput = document.querySelector(Selectors.inputs.siteSecret);\n        if (siteSecretInput && siteSecretInput.value) {\n            values.siteSecret = siteSecretInput.value;\n        }\n\n        const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n        if (eventsInput) {\n            values.monitoredEvents = eventsInput.value;\n        }\n\n        const debugInput = document.querySelector(Selectors.inputs.debugMode);\n        if (debugInput) {\n            values.debugMode = debugInput.checked ? 1 : 0;\n        }\n\n        return values;\n    };\n\n    /**\n     * Handle the Save & Sync button click.\n     */\n    const handleSaveSync = async() => {\n        clearResult();\n        setLoading(true);\n\n        const savingText = await Str.get_string('btn_saving', 'local_mc_plugin');\n        setBtnText(savingText);\n\n        try {\n            // Save settings first\n            const values = getFormValues();\n            const saveResult = await Repository.saveSettings(config.ajaxSaveUrl, config.sesskey, values);\n\n            if (!saveResult.success) {\n                setLoading(false);\n                setBtnText(btnLabel);\n                await showResult(false, saveResult.message || 'Failed to save settings');\n                return;\n            }\n\n            // Then sync events\n            const syncingText = await Str.get_string('btn_syncing', 'local_mc_plugin');\n            setBtnText(syncingText);\n            const syncResult = await Repository.syncEvents(config.syncUrl, config.sesskey);\n\n            setLoading(false);\n            setBtnText(btnLabel);\n\n            if (syncResult.success) {\n                const successMsg = await Str.get_string('sync_success', 'local_mc_plugin', syncResult.event_count || 0);\n                await showResult(true, successMsg);\n                ConnectionStatus.testConnection();\n            } else {\n                const failMsg = await Str.get_string('sync_failed', 'local_mc_plugin', syncResult.message);\n                await showResult(false, failMsg);\n                ConnectionStatus.updateStatusWithError(syncResult.message);\n            }\n        } catch (err) {\n            setLoading(false);\n            setBtnText(btnLabel);\n            await showResult(false, `Error: ${err.message}`);\n        }\n    };\n\n    return {\n        /**\n         * Initialize the action buttons module.\n         *\n         * @param {Object} [cfg] Optional configuration object\n         */\n        init: async function(cfg) {\n            cfg = cfg || null;\n            // Find the action buttons container\n            container = document.querySelector(Selectors.actions.container);\n\n            if (container) {\n                // Read config from data attributes\n                config = {\n                    syncUrl: container.dataset.syncurl || (cfg && cfg.syncUrl) || '',\n                    ajaxSaveUrl: container.dataset.ajaxsaveurl || (cfg && cfg.ajaxSaveUrl) || '',\n                    sesskey: container.dataset.sesskey || (cfg && cfg.sesskey) || '',\n                };\n\n                // Find elements within container\n                resultDiv = container.querySelector(Selectors.actions.resultDiv);\n                primaryBtn = container.querySelector(Selectors.actions.primaryBtn);\n                btnSpinner = container.querySelector(Selectors.actions.btnSpinner);\n                btnTextEl = container.querySelector(Selectors.actions.btnText);\n            } else if (cfg) {\n                // Fallback to passed config and legacy selectors (backward compatibility)\n                config = cfg;\n                resultDiv = document.querySelector(Selectors.actions.legacyResultDiv);\n                primaryBtn = document.querySelector(Selectors.actions.legacyPrimaryBtn);\n                btnSpinner = document.querySelector(Selectors.actions.legacyBtnSpinner);\n                btnTextEl = document.querySelector(Selectors.actions.legacyBtnText);\n            }\n\n            // Load button label string\n            btnLabel = await Str.get_string('btn_save_sync', 'local_mc_plugin');\n\n            if (primaryBtn) {\n                primaryBtn.addEventListener('click', handleSaveSync);\n            }\n        }\n    };\n});\n"],"names":["define","Selectors","Repository","ConnectionStatus","TemplateHelper","Str","config","btnLabel","container","resultDiv","primaryBtn","btnSpinner","btnTextEl","showResult","async","success","message","context","buildActionResultContext","renderActionResult","setLoading","loading","disabled","classList","remove","add","setBtnText","text","textContent","handleSaveSync","innerHTML","savingText","get_string","values","siteKeyInput","document","querySelector","inputs","siteKey","value","siteSecretInput","siteSecret","eventsInput","monitoredEvents","debugInput","debugMode","checked","getFormValues","saveResult","saveSettings","ajaxSaveUrl","sesskey","syncingText","syncResult","syncEvents","syncUrl","successMsg","event_count","testConnection","failMsg","updateStatusWithError","err","init","cfg","actions","dataset","syncurl","ajaxsaveurl","btnText","legacyResultDiv","legacyPrimaryBtn","legacyBtnSpinner","legacyBtnText","addEventListener"],"mappings":"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"}