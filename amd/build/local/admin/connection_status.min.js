/**
 * Connection status module for the admin settings page.
 *
 * Handles status display and polling using Mustache templates
 * for dynamic UI updates.
 *
 * @module     local_mc_plugin/local/admin/connection_status
 * @copyright  2025 Kerem Can Akdag
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["local_mc_plugin/local/admin/selectors","local_mc_plugin/local/admin/repository","local_mc_plugin/local/admin/event_selector","local_mc_plugin/local/admin/templates","core/str"],function(t,e,n,s,a){"use strict";let c={},i="",l=null,o=null;const u=async(e,n)=>{const s=(()=>{const e=document.querySelector(t.inputs.monitoredEvents);return e&&e.value?e.value.split(",").filter(t=>""!==t.trim()).length:0})(),c=(()=>{const e=document.querySelector(t.inputs.monitoredEvents);return e&&e.value?e.value.split(",").map(t=>t.trim()).filter(t=>""!==t):[]})();if(0===e)return await a.get_string("status_events_not_synced","local_mc_plugin");if(e===s&&n){if(c.every(t=>n.includes(t))){return await a.get_string("status_events_synced","local_mc_plugin",e)}}return await a.get_string("status_events_changed","local_mc_plugin")},r=async(t,e,c,l,r)=>{if(!o)return;let _;n.setSyncedEvents(l);let d=null;t?(_=await a.get_string("status_connected","local_mc_plugin"),d=await u(c,l),i&&n.refreshCounter(i)):_=r||await a.get_string("status_not_connected","local_mc_plugin");const g=s.buildConnectionStatusContext(t,_,e,d);await s.renderConnectionStatus(o,g)};return{testConnection:async function(t){if(t=t||!1,!o)return;const n={connected:!1,statusclass:"text-muted",dotclass:"text-muted",statustext:await a.get_string("connect_initializing","local_mc_plugin"),hassitename:!1,hassyncstatus:!1};await s.renderConnectionStatus(o,n);try{const n=await e.getConnectionStatus(c.syncUrl,c.sesskey);if(n.connected)await r(!0,n.site_name,n.synced_event_count||0,n.synced_events||[]),t&&await(async()=>{try{if((await e.syncEvents(c.syncUrl,c.sesskey)).success){const t=await e.getConnectionStatus(c.syncUrl,c.sesskey);t.connected&&await r(!0,t.site_name,t.synced_event_count||0,t.synced_events||[])}}catch(t){}})();else if(n.error)await r(!1,null,0,[],n.error);else if(n.configured){const t=await a.get_string("status_click_connect","local_mc_plugin");await r(!1,null,0,[],t)}else{const t=await a.get_string("status_click_connect_link","local_mc_plugin");await r(!1,null,0,[],t)}}catch(t){await r(!1,null,0,[],t.message)}},updateStatusWithError:async function(t){if(!o)return;const e={connected:!1,statusclass:"text-danger",dotclass:"text-danger",statustext:await a.get_string("status_sync_failed","local_mc_plugin"),hassitename:!1,syncstatus:t,hassyncstatus:!0};await s.renderConnectionStatus(o,e)},init:function(e){e=e||null,l=document.querySelector(t.status.container),l?(c={syncUrl:l.dataset.syncurl||e&&e.syncUrl||"",sesskey:l.dataset.sesskey||e&&e.sesskey||""},i=l.dataset.eventinputid||e&&e.eventInputId||"",o=l.querySelector(t.status.content)):e&&(c=e,i=e.eventInputId||""),this.testConnection(!0)}}});