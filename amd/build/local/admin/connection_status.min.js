define("local_mc_plugin/local/admin/connection_status",["exports","./selectors","./repository","./event_selector","./templates","core/str"],(function(_exports,_selectors,Repository,EventSelector,TemplateHelper,_str){var obj;
/**
   * Connection status module for the admin settings page.
   *
   * Handles status display and polling using Mustache templates
   * for dynamic UI updates.
   *
   * @module     local_mc_plugin/local/admin/connection_status
   * @copyright  2025 Kerem Can Akdag
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.updateStatusWithError=_exports.testConnection=_exports.init=void 0,_selectors=(obj=_selectors)&&obj.__esModule?obj:{default:obj},Repository=_interopRequireWildcard(Repository),EventSelector=_interopRequireWildcard(EventSelector),TemplateHelper=_interopRequireWildcard(TemplateHelper);let config={},eventInputId="",statusContainer=null,statusContent=null;const buildSyncStatusText=async(syncedCount,syncedEvents)=>{const selectedCount=(()=>{const eventsInput=document.querySelector(_selectors.default.inputs.monitoredEvents);return eventsInput&&eventsInput.value?eventsInput.value.split(",").filter((e=>""!==e.trim())).length:0})(),selectedEvents=(()=>{const eventsInput=document.querySelector(_selectors.default.inputs.monitoredEvents);return eventsInput&&eventsInput.value?eventsInput.value.split(",").map((e=>e.trim())).filter((e=>""!==e)):[]})();if(0===syncedCount)return await(0,_str.get_string)("status_events_not_synced","local_mc_plugin");if(syncedCount===selectedCount&&syncedEvents){if(selectedEvents.every((e=>syncedEvents.includes(e)))){return await(0,_str.get_string)("status_events_synced","local_mc_plugin",syncedCount)}}return await(0,_str.get_string)("status_events_changed","local_mc_plugin")},updateStatus=async(connected,siteName,syncedCount,syncedEvents,message)=>{if(!statusContent)return;let statusText;EventSelector.setSyncedEvents(syncedEvents);let syncStatus=null;connected?(statusText=await(0,_str.get_string)("status_connected","local_mc_plugin"),syncStatus=await buildSyncStatusText(syncedCount,syncedEvents),eventInputId&&EventSelector.refreshCounter(eventInputId)):statusText=message||await(0,_str.get_string)("status_not_connected","local_mc_plugin");const context=TemplateHelper.buildConnectionStatusContext(connected,statusText,siteName,syncStatus);await TemplateHelper.renderConnectionStatus(statusContent,context)},testConnection=async function(){let autoSync=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!statusContent)return;const checkingText=await(0,_str.get_string)("connect_initializing","local_mc_plugin"),loadingContext={connected:!1,statusclass:"text-muted",dotclass:"text-muted",statustext:checkingText,hassitename:!1,hassyncstatus:!1};await TemplateHelper.renderConnectionStatus(statusContent,loadingContext);try{const data=await Repository.getConnectionStatus(config.syncUrl,config.sesskey);if(data.connected)await updateStatus(!0,data.site_name,data.synced_event_count||0,data.synced_events||[]),autoSync&&await syncEventsInBackground();else if(data.error)await updateStatus(!1,null,0,[],data.error);else if(data.configured){const msg=await(0,_str.get_string)("status_click_connect","local_mc_plugin");await updateStatus(!1,null,0,[],msg)}else{const msg=await(0,_str.get_string)("status_click_connect_link","local_mc_plugin");await updateStatus(!1,null,0,[],msg)}}catch(err){await updateStatus(!1,null,0,[],err.message)}};_exports.testConnection=testConnection;const syncEventsInBackground=async()=>{try{if((await Repository.syncEvents(config.syncUrl,config.sesskey)).success){const data=await Repository.getConnectionStatus(config.syncUrl,config.sesskey);data.connected&&await updateStatus(!0,data.site_name,data.synced_event_count||0,data.synced_events||[])}}catch(err){}};_exports.updateStatusWithError=async errorMessage=>{if(!statusContent)return;const context={connected:!1,statusclass:"text-danger",dotclass:"text-danger",statustext:await(0,_str.get_string)("status_sync_failed","local_mc_plugin"),hassitename:!1,syncstatus:errorMessage,hassyncstatus:!0};await TemplateHelper.renderConnectionStatus(statusContent,context)};_exports.init=function(){let cfg=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;statusContainer=document.querySelector(_selectors.default.status.container),statusContainer?(config={syncUrl:statusContainer.dataset.syncurl||cfg&&cfg.syncUrl||"",sesskey:statusContainer.dataset.sesskey||cfg&&cfg.sesskey||""},eventInputId=statusContainer.dataset.eventinputid||cfg&&cfg.eventInputId||"",statusContent=statusContainer.querySelector(_selectors.default.status.content)):cfg&&(config=cfg,eventInputId=cfg.eventInputId||""),testConnection(!0)}}));

//# sourceMappingURL=connection_status.min.js.map