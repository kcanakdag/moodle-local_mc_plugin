{"version":3,"file":"connection_status.min.js","sources":["../../../src/local/admin/connection_status.js"],"sourcesContent":["/**\n * Connection status module for the admin settings page.\n *\n * Handles status display and polling.\n *\n * @module     local_mc_plugin/local/admin/connection_status\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './selectors';\nimport * as Repository from './repository';\nimport * as EventSelector from './event_selector';\n\n/** @type {Object} Configuration */\nlet config = {};\n\n/** @type {string} Event selector input ID for refreshing counter */\nlet eventInputId = '';\n\n/**\n * Get the count of selected events from the form.\n *\n * @returns {number}\n */\nconst getSelectedEventCount = () => {\n    const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n    if (!eventsInput || !eventsInput.value) {\n        return 0;\n    }\n    return eventsInput.value.split(',').filter((e) => e.trim() !== '').length;\n};\n\n/**\n * Get the list of selected events from the form.\n *\n * @returns {Array<string>}\n */\nconst getSelectedEvents = () => {\n    const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n    if (!eventsInput || !eventsInput.value) {\n        return [];\n    }\n    return eventsInput.value.split(',').map((e) => e.trim()).filter((e) => e !== '');\n};\n\n/**\n * Update the status display.\n *\n * @param {boolean} connected Whether connected\n * @param {string|null} siteName Site name if connected\n * @param {number} syncedCount Number of synced events\n * @param {Array} syncedEvents Array of synced event names\n * @param {string|null} message Error message if not connected\n */\nconst updateStatus = (connected, siteName, syncedCount, syncedEvents, message) => {\n    const statusDot = document.querySelector(Selectors.status.dot);\n    const statusText = document.querySelector(Selectors.status.text);\n    const siteNameEl = document.querySelector(Selectors.status.siteName);\n    const syncStatus = document.querySelector(Selectors.status.syncStatus);\n    const testResult = document.querySelector(Selectors.status.testResult);\n\n    if (!statusDot || !statusText) {\n        return;\n    }\n\n    // Update event selector with synced events\n    EventSelector.setSyncedEvents(syncedEvents);\n\n    if (connected) {\n        statusDot.style.color = '#28a745';\n        statusText.style.color = '#155724';\n        statusText.textContent = 'Connected';\n\n        if (siteName && siteNameEl) {\n            siteNameEl.textContent = `(${siteName})`;\n        }\n\n        if (testResult) {\n            testResult.innerHTML = '';\n        }\n\n        const selectedCount = getSelectedEventCount();\n        const selectedEvents = getSelectedEvents();\n\n        if (syncStatus) {\n            if (syncedCount === 0) {\n                syncStatus.innerHTML = '<span style=\"color: #856404;\">• Events not synced yet</span>';\n            } else if (syncedCount === selectedCount && syncedEvents) {\n                const allMatch = selectedEvents.every((e) => syncedEvents.includes(e));\n                if (allMatch) {\n                    syncStatus.innerHTML = `<span style=\"color: #155724;\">• ${syncedCount} events synced</span>`;\n                } else {\n                    syncStatus.innerHTML = '<span style=\"color: #856404;\">• Events changed, click Save & Sync</span>';\n                }\n            } else {\n                const diff = selectedCount - syncedCount;\n                if (diff > 0) {\n                    syncStatus.innerHTML = `<span style=\"color: #856404;\">• ${diff} new event(s) to sync</span>`;\n                } else {\n                    syncStatus.innerHTML = '<span style=\"color: #856404;\">• Events changed, click Save & Sync</span>';\n                }\n            }\n        }\n\n        // Refresh event selector counter\n        if (eventInputId) {\n            EventSelector.refreshCounter(eventInputId);\n        }\n    } else {\n        statusDot.style.color = '#dc3545';\n        statusText.style.color = '#721c24';\n        statusText.textContent = 'Not connected';\n\n        if (siteNameEl) {\n            siteNameEl.textContent = '';\n        }\n        if (syncStatus) {\n            syncStatus.textContent = '';\n        }\n        if (testResult) {\n            testResult.innerHTML = `<span style=\"color: #dc3545;\">${message || 'Connection failed'}</span>`;\n        }\n    }\n};\n\n/**\n * Test the connection and update status.\n */\nexport const testConnection = async() => {\n    const statusDot = document.querySelector(Selectors.status.dot);\n    const statusText = document.querySelector(Selectors.status.text);\n    const syncStatus = document.querySelector(Selectors.status.syncStatus);\n    const testResult = document.querySelector(Selectors.status.testResult);\n\n    if (statusDot) {\n        statusDot.style.color = '#6c757d';\n    }\n    if (statusText) {\n        statusText.style.color = '#6c757d';\n        statusText.textContent = 'Checking...';\n    }\n    if (syncStatus) {\n        syncStatus.textContent = '';\n    }\n    if (testResult) {\n        testResult.innerHTML = '';\n    }\n\n    try {\n        const data = await Repository.getConnectionStatus(config.syncUrl, config.sesskey);\n\n        if (data.connected) {\n            updateStatus(true, data.site_name, data.synced_event_count || 0, data.synced_events || []);\n        } else if (data.error) {\n            updateStatus(false, null, 0, [], data.error);\n        } else if (data.configured) {\n            updateStatus(false, null, 0, [], 'Click Connect to link your site');\n        } else {\n            updateStatus(false, null, 0, [], 'Click Connect to link your Moodle site');\n        }\n    } catch (err) {\n        updateStatus(false, null, 0, [], err.message);\n    }\n};\n\n/**\n * Update status with an error message (for sync failures).\n *\n * @param {string} errorMessage The error message\n */\nexport const updateStatusWithError = (errorMessage) => {\n    const statusDot = document.querySelector(Selectors.status.dot);\n    const statusText = document.querySelector(Selectors.status.text);\n    const syncStatus = document.querySelector(Selectors.status.syncStatus);\n\n    if (statusDot) {\n        statusDot.style.color = '#dc3545';\n    }\n    if (statusText) {\n        statusText.style.color = '#721c24';\n        statusText.textContent = 'Sync failed';\n    }\n    if (syncStatus) {\n        syncStatus.innerHTML = `<span style=\"color: #dc3545;\">• ${errorMessage}</span>`;\n    }\n};\n\n/**\n * Initialize the connection status module.\n *\n * @param {Object} cfg Configuration object\n * @param {string} cfg.syncUrl URL to sync_schema.php\n * @param {string} cfg.sesskey Moodle session key\n * @param {string} cfg.eventInputId Event selector input ID\n */\nexport const init = (cfg) => {\n    config = cfg;\n    eventInputId = cfg.eventInputId || '';\n\n    // Initial status check\n    testConnection();\n};\n"],"names":["config","eventInputId","updateStatus","connected","siteName","syncedCount","syncedEvents","message","statusDot","document","querySelector","Selectors","status","dot","statusText","text","siteNameEl","syncStatus","testResult","EventSelector","setSyncedEvents","style","color","textContent","innerHTML","selectedCount","eventsInput","inputs","monitoredEvents","value","split","filter","e","trim","length","getSelectedEventCount","selectedEvents","map","getSelectedEvents","allMatch","every","includes","diff","refreshCounter","testConnection","async","data","Repository","getConnectionStatus","syncUrl","sesskey","site_name","synced_event_count","synced_events","error","configured","err","errorMessage","cfg"],"mappings":";;;;;;;;;suCAeIA,OAAS,GAGTC,aAAe,SAqCbC,aAAe,CAACC,UAAWC,SAAUC,YAAaC,aAAcC,iBAC5DC,UAAYC,SAASC,cAAcC,mBAAUC,OAAOC,KACpDC,WAAaL,SAASC,cAAcC,mBAAUC,OAAOG,MACrDC,WAAaP,SAASC,cAAcC,mBAAUC,OAAOR,UACrDa,WAAaR,SAASC,cAAcC,mBAAUC,OAAOK,YACrDC,WAAaT,SAASC,cAAcC,mBAAUC,OAAOM,eAEtDV,WAAcM,cAKnBK,cAAcC,gBAAgBd,cAE1BH,UAAW,CACXK,UAAUa,MAAMC,MAAQ,UACxBR,WAAWO,MAAMC,MAAQ,UACzBR,WAAWS,YAAc,YAErBnB,UAAYY,aACZA,WAAWO,uBAAkBnB,eAG7Bc,aACAA,WAAWM,UAAY,UAGrBC,cAzDgB,YACpBC,YAAcjB,SAASC,cAAcC,mBAAUgB,OAAOC,wBACvDF,aAAgBA,YAAYG,MAG1BH,YAAYG,MAAMC,MAAM,KAAKC,QAAQC,GAAmB,KAAbA,EAAEC,SAAeC,OAFxD,GAsDeC,GAChBC,eA7CY,YAChBV,YAAcjB,SAASC,cAAcC,mBAAUgB,OAAOC,wBACvDF,aAAgBA,YAAYG,MAG1BH,YAAYG,MAAMC,MAAM,KAAKO,KAAKL,GAAMA,EAAEC,SAAQF,QAAQC,GAAY,KAANA,IAF5D,IA0CgBM,MAEnBrB,cACoB,IAAhBZ,YACAY,WAAWO,UAAY,oEACpB,GAAInB,cAAgBoB,eAAiBnB,aAAc,OAChDiC,SAAWH,eAAeI,OAAOR,GAAM1B,aAAamC,SAAST,KAE/Df,WAAWO,UADXe,mDAC0DlC,qCAEnC,+EAExB,OACGqC,KAAOjB,cAAgBpB,YAEzBY,WAAWO,UADXkB,KAAO,4CACmDA,qCAEnC,2EAM/BzC,cACAkB,cAAcwB,eAAe1C,mBAGjCO,UAAUa,MAAMC,MAAQ,UACxBR,WAAWO,MAAMC,MAAQ,UACzBR,WAAWS,YAAc,gBAErBP,aACAA,WAAWO,YAAc,IAEzBN,aACAA,WAAWM,YAAc,IAEzBL,aACAA,WAAWM,kDAA6CjB,SAAW,iCAQlEqC,eAAiBC,gBACpBrC,UAAYC,SAASC,cAAcC,mBAAUC,OAAOC,KACpDC,WAAaL,SAASC,cAAcC,mBAAUC,OAAOG,MACrDE,WAAaR,SAASC,cAAcC,mBAAUC,OAAOK,YACrDC,WAAaT,SAASC,cAAcC,mBAAUC,OAAOM,YAEvDV,YACAA,UAAUa,MAAMC,MAAQ,WAExBR,aACAA,WAAWO,MAAMC,MAAQ,UACzBR,WAAWS,YAAc,eAEzBN,aACAA,WAAWM,YAAc,IAEzBL,aACAA,WAAWM,UAAY,cAIjBsB,WAAaC,WAAWC,oBAAoBhD,OAAOiD,QAASjD,OAAOkD,SAErEJ,KAAK3C,UACLD,cAAa,EAAM4C,KAAKK,UAAWL,KAAKM,oBAAsB,EAAGN,KAAKO,eAAiB,IAChFP,KAAKQ,MACZpD,cAAa,EAAO,KAAM,EAAG,GAAI4C,KAAKQ,OAC/BR,KAAKS,WACZrD,cAAa,EAAO,KAAM,EAAG,GAAI,mCAEjCA,cAAa,EAAO,KAAM,EAAG,GAAI,0CAEvC,MAAOsD,KACLtD,cAAa,EAAO,KAAM,EAAG,GAAIsD,IAAIjD,iFASPkD,qBAC5BjD,UAAYC,SAASC,cAAcC,mBAAUC,OAAOC,KACpDC,WAAaL,SAASC,cAAcC,mBAAUC,OAAOG,MACrDE,WAAaR,SAASC,cAAcC,mBAAUC,OAAOK,YAEvDT,YACAA,UAAUa,MAAMC,MAAQ,WAExBR,aACAA,WAAWO,MAAMC,MAAQ,UACzBR,WAAWS,YAAc,eAEzBN,aACAA,WAAWO,oDAA+CiC,wCAY7CC,MACjB1D,OAAS0D,IACTzD,aAAeyD,IAAIzD,cAAgB,GAGnC2C"}