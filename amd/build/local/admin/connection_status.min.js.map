{"version":3,"file":"connection_status.min.js","sources":["../../../src/local/admin/connection_status.js"],"sourcesContent":["/**\n * Connection status module for the admin settings page.\n *\n * Handles status display and polling using Mustache templates\n * for dynamic UI updates.\n *\n * @module     local_mc_plugin/local/admin/connection_status\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './selectors';\nimport * as Repository from './repository';\nimport * as EventSelector from './event_selector';\nimport * as TemplateHelper from './templates';\nimport {get_string as getString} from 'core/str';\n\n/** @type {Object} Configuration */\nlet config = {};\n\n/** @type {string} Event selector input ID for refreshing counter */\nlet eventInputId = '';\n\n/** @type {HTMLElement|null} Status container element */\nlet statusContainer = null;\n\n/** @type {HTMLElement|null} Status content element for template rendering */\nlet statusContent = null;\n\n/**\n * Get the count of selected events from the form.\n *\n * @returns {number}\n */\nconst getSelectedEventCount = () => {\n    const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n    if (!eventsInput || !eventsInput.value) {\n        return 0;\n    }\n    return eventsInput.value.split(',').filter((e) => e.trim() !== '').length;\n};\n\n/**\n * Get the list of selected events from the form.\n *\n * @returns {Array<string>}\n */\nconst getSelectedEvents = () => {\n    const eventsInput = document.querySelector(Selectors.inputs.monitoredEvents);\n    if (!eventsInput || !eventsInput.value) {\n        return [];\n    }\n    return eventsInput.value.split(',').map((e) => e.trim()).filter((e) => e !== '');\n};\n\n\n/**\n * Build sync status text based on selected and synced events.\n *\n * @param {number} syncedCount Number of synced events\n * @param {Array} syncedEvents Array of synced event names\n * @returns {Promise<string|null>} Sync status text or null\n */\nconst buildSyncStatusText = async(syncedCount, syncedEvents) => {\n    const selectedCount = getSelectedEventCount();\n    const selectedEvents = getSelectedEvents();\n\n    if (syncedCount === 0) {\n        return await getString('status_events_not_synced', 'local_mc_plugin');\n    }\n\n    if (syncedCount === selectedCount && syncedEvents) {\n        const allMatch = selectedEvents.every((e) => syncedEvents.includes(e));\n        if (allMatch) {\n            const str = await getString('status_events_synced', 'local_mc_plugin', syncedCount);\n            return str;\n        }\n    }\n\n    // Events changed\n    return await getString('status_events_changed', 'local_mc_plugin');\n};\n\n/**\n * Update the status display using template rendering.\n *\n * @param {boolean} connected Whether connected\n * @param {string|null} siteName Site name if connected\n * @param {number} syncedCount Number of synced events\n * @param {Array} syncedEvents Array of synced event names\n * @param {string|null} message Error message if not connected\n */\nconst updateStatus = async(connected, siteName, syncedCount, syncedEvents, message) => {\n    if (!statusContent) {\n        return;\n    }\n\n    // Update event selector with synced events\n    EventSelector.setSyncedEvents(syncedEvents);\n\n    let statusText;\n    let syncStatus = null;\n\n    if (connected) {\n        statusText = await getString('status_connected', 'local_mc_plugin');\n        syncStatus = await buildSyncStatusText(syncedCount, syncedEvents);\n\n        // Refresh event selector counter\n        if (eventInputId) {\n            EventSelector.refreshCounter(eventInputId);\n        }\n    } else {\n        statusText = message || await getString('status_not_connected', 'local_mc_plugin');\n    }\n\n    // Build context and render template\n    const context = TemplateHelper.buildConnectionStatusContext(\n        connected,\n        statusText,\n        siteName,\n        syncStatus\n    );\n\n    await TemplateHelper.renderConnectionStatus(statusContent, context);\n};\n\n/**\n * Test the connection and update status.\n */\nexport const testConnection = async() => {\n    if (!statusContent) {\n        return;\n    }\n\n    // Show loading state - render with checking text\n    const checkingText = await getString('connect_initializing', 'local_mc_plugin');\n    const loadingContext = {\n        connected: false,\n        statusclass: 'text-muted',\n        dotclass: 'text-muted',\n        statustext: checkingText,\n        hassitename: false,\n        hassyncstatus: false,\n    };\n    await TemplateHelper.renderConnectionStatus(statusContent, loadingContext);\n\n    try {\n        const data = await Repository.getConnectionStatus(config.syncUrl, config.sesskey);\n\n        if (data.connected) {\n            await updateStatus(true, data.site_name, data.synced_event_count || 0, data.synced_events || []);\n        } else if (data.error) {\n            await updateStatus(false, null, 0, [], data.error);\n        } else if (data.configured) {\n            const msg = await getString('status_click_connect', 'local_mc_plugin');\n            await updateStatus(false, null, 0, [], msg);\n        } else {\n            const msg = await getString('status_click_connect_link', 'local_mc_plugin');\n            await updateStatus(false, null, 0, [], msg);\n        }\n    } catch (err) {\n        await updateStatus(false, null, 0, [], err.message);\n    }\n};\n\n/**\n * Update status with an error message (for sync failures).\n *\n * @param {string} errorMessage The error message\n */\nexport const updateStatusWithError = async(errorMessage) => {\n    if (!statusContent) {\n        return;\n    }\n\n    const syncFailedText = await getString('status_sync_failed', 'local_mc_plugin');\n    const context = {\n        connected: false,\n        statusclass: 'text-danger',\n        dotclass: 'text-danger',\n        statustext: syncFailedText,\n        hassitename: false,\n        syncstatus: errorMessage,\n        hassyncstatus: true,\n    };\n\n    await TemplateHelper.renderConnectionStatus(statusContent, context);\n};\n\n/**\n * Initialize the connection status module.\n *\n * Reads configuration from data attributes on the container element.\n *\n * @param {Object} [cfg] Optional configuration object (for backward compatibility)\n * @param {string} [cfg.syncUrl] URL to sync_schema.php\n * @param {string} [cfg.sesskey] Moodle session key\n * @param {string} [cfg.eventInputId] Event selector input ID\n */\nexport const init = (cfg = null) => {\n    // Find the status container\n    statusContainer = document.querySelector(Selectors.status.container);\n\n    if (statusContainer) {\n        // Read config from data attributes\n        config = {\n            syncUrl: statusContainer.dataset.syncurl || (cfg && cfg.syncUrl) || '',\n            sesskey: statusContainer.dataset.sesskey || (cfg && cfg.sesskey) || '',\n        };\n        eventInputId = statusContainer.dataset.eventinputid || (cfg && cfg.eventInputId) || '';\n\n        // Find the content area for template rendering\n        statusContent = statusContainer.querySelector(Selectors.status.content);\n    } else if (cfg) {\n        // Fallback to passed config (backward compatibility)\n        config = cfg;\n        eventInputId = cfg.eventInputId || '';\n    }\n\n    // Initial status check\n    testConnection();\n};\n"],"names":["config","eventInputId","statusContainer","statusContent","buildSyncStatusText","async","syncedCount","syncedEvents","selectedCount","eventsInput","document","querySelector","Selectors","inputs","monitoredEvents","value","split","filter","e","trim","length","getSelectedEventCount","selectedEvents","map","getSelectedEvents","every","includes","updateStatus","connected","siteName","message","statusText","EventSelector","setSyncedEvents","syncStatus","refreshCounter","context","TemplateHelper","buildConnectionStatusContext","renderConnectionStatus","testConnection","loadingContext","statusclass","dotclass","statustext","hassitename","hassyncstatus","data","Repository","getConnectionStatus","syncUrl","sesskey","site_name","synced_event_count","synced_events","error","configured","msg","err","syncstatus","errorMessage","cfg","status","container","dataset","syncurl","eventinputid","content"],"mappings":";;;;;;;;;;6xCAkBIA,OAAS,GAGTC,aAAe,GAGfC,gBAAkB,KAGlBC,cAAgB,WAoCdC,oBAAsBC,MAAMC,YAAaC,sBACrCC,cA9BoB,YACpBC,YAAcC,SAASC,cAAcC,mBAAUC,OAAOC,wBACvDL,aAAgBA,YAAYM,MAG1BN,YAAYM,MAAMC,MAAM,KAAKC,QAAQC,GAAmB,KAAbA,EAAEC,SAAeC,OAFxD,GA2BWC,GAChBC,eAlBgB,YAChBb,YAAcC,SAASC,cAAcC,mBAAUC,OAAOC,wBACvDL,aAAgBA,YAAYM,MAG1BN,YAAYM,MAAMC,MAAM,KAAKO,KAAKL,GAAMA,EAAEC,SAAQF,QAAQC,GAAY,KAANA,IAF5D,IAeYM,MAEH,IAAhBlB,yBACa,mBAAU,2BAA4B,sBAGnDA,cAAgBE,eAAiBD,aAAc,IAC9Be,eAAeG,OAAOP,GAAMX,aAAamB,SAASR,KACrD,cACQ,mBAAU,uBAAwB,kBAAmBZ,2BAMlE,mBAAU,wBAAyB,oBAY9CqB,aAAetB,MAAMuB,UAAWC,SAAUvB,YAAaC,aAAcuB,eAClE3B,yBAOD4B,WAFJC,cAAcC,gBAAgB1B,kBAG1B2B,WAAa,KAEbN,WACAG,iBAAmB,mBAAU,mBAAoB,mBACjDG,iBAAmB9B,oBAAoBE,YAAaC,cAGhDN,cACA+B,cAAcG,eAAelC,eAGjC8B,WAAaD,eAAiB,mBAAU,uBAAwB,yBAI9DM,QAAUC,eAAeC,6BAC3BV,UACAG,WACAF,SACAK,kBAGEG,eAAeE,uBAAuBpC,cAAeiC,UAMlDI,eAAiBnC,cACrBF,2BAMCsC,eAAiB,CACnBb,WAAW,EACXc,YAAa,aACbC,SAAU,aACVC,iBALuB,mBAAU,uBAAwB,mBAMzDC,aAAa,EACbC,eAAe,SAEbT,eAAeE,uBAAuBpC,cAAesC,0BAGjDM,WAAaC,WAAWC,oBAAoBjD,OAAOkD,QAASlD,OAAOmD,YAErEJ,KAAKnB,gBACCD,cAAa,EAAMoB,KAAKK,UAAWL,KAAKM,oBAAsB,EAAGN,KAAKO,eAAiB,SAC1F,GAAIP,KAAKQ,YACN5B,cAAa,EAAO,KAAM,EAAG,GAAIoB,KAAKQ,YACzC,GAAIR,KAAKS,WAAY,OAClBC,UAAY,mBAAU,uBAAwB,yBAC9C9B,cAAa,EAAO,KAAM,EAAG,GAAI8B,SACpC,OACGA,UAAY,mBAAU,4BAA6B,yBACnD9B,cAAa,EAAO,KAAM,EAAG,GAAI8B,MAE7C,MAAOC,WACC/B,cAAa,EAAO,KAAM,EAAG,GAAI+B,IAAI5B,iFASdzB,MAAAA,mBAC5BF,2BAKCiC,QAAU,CACZR,WAAW,EACXc,YAAa,cACbC,SAAU,cACVC,iBALyB,mBAAU,qBAAsB,mBAMzDC,aAAa,EACbc,WAAYC,aACZd,eAAe,SAGbT,eAAeE,uBAAuBpC,cAAeiC,wBAa3C,eAACyB,2DAAM,KAEvB3D,gBAAkBQ,SAASC,cAAcC,mBAAUkD,OAAOC,WAEtD7D,iBAEAF,OAAS,CACLkD,QAAShD,gBAAgB8D,QAAQC,SAAYJ,KAAOA,IAAIX,SAAY,GACpEC,QAASjD,gBAAgB8D,QAAQb,SAAYU,KAAOA,IAAIV,SAAY,IAExElD,aAAeC,gBAAgB8D,QAAQE,cAAiBL,KAAOA,IAAI5D,cAAiB,GAGpFE,cAAgBD,gBAAgBS,cAAcC,mBAAUkD,OAAOK,UACxDN,MAEP7D,OAAS6D,IACT5D,aAAe4D,IAAI5D,cAAgB,IAIvCuC"}