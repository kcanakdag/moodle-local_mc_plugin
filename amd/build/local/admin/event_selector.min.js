/**
 * Event selector module for the admin settings page.
 *
 * Handles event search, filtering, and bulk selection.
 * Uses data-* attributes from event_selector.mustache template.
 *
 * @module     local_mc_plugin/local/admin/event_selector
 * @copyright  2025 Kerem Can Akdag
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["local_mc_plugin/local/admin/selectors","core/str"],function(e,t){"use strict";let n=[],c={},l=null,s=null,o=null;const r=()=>{if(!s||!o)return;const t=[];if((l?l.querySelectorAll(`${e.events.checkbox}:checked`):document.querySelectorAll(`${e.events.checkbox}:checked, ${e.events.legacyCheckbox}:checked`)).forEach(n=>{const c=n.closest(e.events.eventItem);c&&c.dataset.class&&t.push(c.dataset.class)}),s.value=t.join(","),n.length>0){const e=t.filter(e=>!n.includes(e)).length,l=n.filter(e=>!t.includes(e)).length;if(0===e&&0===l)o.innerHTML=c.selectedCount.replace("{$a}",t.length)+` <span class="text-success">• ${c.allSynced}</span>`;else{const n=[];e>0&&n.push(`${e} ${c.newEvents}`),l>0&&n.push(`${l} ${c.removed}`),o.innerHTML=c.selectedCount.replace("{$a}",t.length)+` <span class="text-warning">• ${n.join(", ")}</span>`}}else o.textContent=c.selectedCount.replace("{$a}",t.length)},a=t=>{const n=t.toLowerCase();(l?l.querySelectorAll(e.events.eventItem):document.querySelectorAll(e.events.eventItem)).forEach(t=>{t.textContent.toLowerCase().includes(n)?t.classList.remove(e.events.hiddenClass):t.classList.add(e.events.hiddenClass)});(l?l.querySelectorAll(e.events.category):document.querySelectorAll(e.events.category)).forEach(t=>{0===t.querySelectorAll(`${e.events.eventItem}:not(.${e.events.hiddenClass})`).length?t.classList.add(e.events.hiddenClass):t.classList.remove(e.events.hiddenClass)})},d=()=>{const t=`${e.events.eventItem}:not(.${e.events.hiddenClass}) ${e.events.checkbox}`;(l?l.querySelectorAll(t):document.querySelectorAll(t)).forEach(e=>{e.checked=!0}),r()},i=()=>{const t=`${e.events.eventItem}:not(.${e.events.hiddenClass}) ${e.events.checkbox}`;(l?l.querySelectorAll(t):document.querySelectorAll(t)).forEach(e=>{e.checked=!1}),r()};return{setSyncedEvents:function(e){n=e||[]},refreshCounter:function(e){r()},init:async function(n){if(n=n||null,await(async()=>{const e=await t.get_strings([{key:"event_selected_count",component:"local_mc_plugin"},{key:"event_all_synced",component:"local_mc_plugin"},{key:"event_new",component:"local_mc_plugin"},{key:"event_removed",component:"local_mc_plugin"}]);c={selectedCount:e[0],allSynced:e[1],newEvents:e[2],removed:e[3]}})(),l=document.querySelector(e.events.container),l){s=l.querySelector(e.events.hiddenInput),o=l.querySelector(e.events.counter);const t=l.querySelector(e.events.searchInput);t&&t.addEventListener("keyup",e=>{a(e.target.value)});const n=l.querySelector(e.events.selectVisibleBtn);n&&n.addEventListener("click",d);const c=l.querySelector(e.events.deselectVisibleBtn);c&&c.addEventListener("click",i),l.querySelectorAll(e.events.categoryTitle).forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",()=>{const t=e.nextElementSibling;t&&(t.style.display="none"===t.style.display?"block":"none")})})}else if(n){s=document.getElementById(n),o=document.querySelector(e.events.legacyCounter(n));const t=document.querySelector(e.events.legacySearchInput(n));t&&t.addEventListener("keyup",e=>{a(e.target.value)});const c=document.querySelector(e.events.legacySelectVisibleBtn(n));c&&c.addEventListener("click",d);const l=document.querySelector(e.events.legacyDeselectVisibleBtn(n));l&&l.addEventListener("click",i),document.querySelectorAll(e.events.categoryTitle).forEach(e=>{e.style.cursor="pointer",e.addEventListener("click",()=>{const t=e.nextElementSibling;t&&(t.style.display="none"===t.style.display?"block":"none")})})}r(),document.addEventListener("change",t=>{(t.target.matches(e.events.checkbox)||t.target.matches(e.events.legacyCheckbox))&&r()})}}});