{"version":3,"file":"event_selector.min.js","sources":["../../../src/local/admin/event_selector.js"],"sourcesContent":["/**\n * Event selector module for the admin settings page.\n *\n * Handles event search, filtering, and bulk selection.\n * Uses data-* attributes from event_selector.mustache template.\n *\n * @module     local_mc_plugin/local/admin/event_selector\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './selectors';\nimport {get_strings as getStrings} from 'core/str';\n\n/** @type {Array} Currently synced events from MoodleConnect */\nlet syncedEvents = [];\n\n/** @type {Object} Language strings */\nlet strings = {};\n\n/** @type {HTMLElement|null} Event selector container */\nlet container = null;\n\n/** @type {HTMLElement|null} Hidden input element */\nlet hiddenInput = null;\n\n/** @type {HTMLElement|null} Counter element */\nlet counterEl = null;\n\n/**\n * Load language strings.\n *\n * @returns {Promise<void>}\n */\nconst loadStrings = async() => {\n    const results = await getStrings([\n        {key: 'event_selected_count', component: 'local_mc_plugin'},\n        {key: 'event_all_synced', component: 'local_mc_plugin'},\n        {key: 'event_new', component: 'local_mc_plugin'},\n        {key: 'event_removed', component: 'local_mc_plugin'},\n    ]);\n\n    strings = {\n        selectedCount: results[0],\n        allSynced: results[1],\n        newEvents: results[2],\n        removed: results[3],\n    };\n};\n\n/**\n * Update the hidden input value with selected events.\n */\nconst updateValue = () => {\n    if (!hiddenInput || !counterEl) {\n        return;\n    }\n\n    const selected = [];\n    // Use data-action selector for checkboxes from template\n    const checkboxes = container ?\n        container.querySelectorAll(`${Selectors.events.checkbox}:checked`) :\n        document.querySelectorAll(`${Selectors.events.checkbox}:checked, ${Selectors.events.legacyCheckbox}:checked`);\n\n    checkboxes.forEach((cb) => {\n        // Get class from parent mc-event-item's data-class attribute\n        const eventItem = cb.closest(Selectors.events.eventItem);\n        if (eventItem && eventItem.dataset.class) {\n            selected.push(eventItem.dataset.class);\n        }\n    });\n\n    hiddenInput.value = selected.join(',');\n\n    // Update counter with sync status\n    if (syncedEvents.length > 0) {\n        const toAdd = selected.filter((evt) => !syncedEvents.includes(evt)).length;\n        const toRemove = syncedEvents.filter((evt) => !selected.includes(evt)).length;\n\n        if (toAdd === 0 && toRemove === 0) {\n            counterEl.innerHTML = strings.selectedCount.replace('{$a}', selected.length) +\n                ` <span class=\"text-success\">• ${strings.allSynced}</span>`;\n        } else {\n            const changes = [];\n            if (toAdd > 0) {\n                changes.push(`${toAdd} ${strings.newEvents}`);\n            }\n            if (toRemove > 0) {\n                changes.push(`${toRemove} ${strings.removed}`);\n            }\n            counterEl.innerHTML = strings.selectedCount.replace('{$a}', selected.length) +\n                ` <span class=\"text-warning\">• ${changes.join(', ')}</span>`;\n        }\n    } else {\n        counterEl.textContent = strings.selectedCount.replace('{$a}', selected.length);\n    }\n};\n\n\n/**\n * Filter events based on search term.\n *\n * @param {string} term Search term\n */\nconst filterEvents = (term) => {\n    const lowerTerm = term.toLowerCase();\n    const eventItems = container ?\n        container.querySelectorAll(Selectors.events.eventItem) :\n        document.querySelectorAll(Selectors.events.eventItem);\n\n    eventItems.forEach((item) => {\n        const text = item.textContent.toLowerCase();\n        if (text.includes(lowerTerm)) {\n            item.classList.remove(Selectors.events.hiddenClass);\n        } else {\n            item.classList.add(Selectors.events.hiddenClass);\n        }\n    });\n\n    // Hide empty categories\n    const categories = container ?\n        container.querySelectorAll(Selectors.events.category) :\n        document.querySelectorAll(Selectors.events.category);\n\n    categories.forEach((cat) => {\n        const visible = cat.querySelectorAll(`${Selectors.events.eventItem}:not(.${Selectors.events.hiddenClass})`).length;\n        if (visible === 0) {\n            cat.classList.add(Selectors.events.hiddenClass);\n        } else {\n            cat.classList.remove(Selectors.events.hiddenClass);\n        }\n    });\n};\n\n/**\n * Select all visible checkboxes.\n */\nconst selectVisible = () => {\n    const selector = `${Selectors.events.eventItem}:not(.${Selectors.events.hiddenClass}) ${Selectors.events.checkbox}`;\n    const checkboxes = container ?\n        container.querySelectorAll(selector) :\n        document.querySelectorAll(selector);\n\n    checkboxes.forEach((cb) => {\n        cb.checked = true;\n    });\n    updateValue();\n};\n\n/**\n * Deselect all visible checkboxes.\n */\nconst deselectVisible = () => {\n    const selector = `${Selectors.events.eventItem}:not(.${Selectors.events.hiddenClass}) ${Selectors.events.checkbox}`;\n    const checkboxes = container ?\n        container.querySelectorAll(selector) :\n        document.querySelectorAll(selector);\n\n    checkboxes.forEach((cb) => {\n        cb.checked = false;\n    });\n    updateValue();\n};\n\n/**\n * Set the synced events array.\n *\n * @param {Array} events Array of synced event class names\n */\nexport const setSyncedEvents = (events) => {\n    syncedEvents = events || [];\n};\n\n/**\n * Trigger a counter update (called from other modules).\n *\n * @param {string} [inputId] The input element ID (for backward compatibility, ignored)\n */\nexport const refreshCounter = (inputId) => { // eslint-disable-line no-unused-vars\n    updateValue();\n};\n\n/**\n * Initialize the event selector.\n *\n * Finds elements using data-* attribute selectors from the template.\n * Falls back to legacy ID-based selectors for backward compatibility.\n *\n * @param {string} [inputId] The hidden input element ID (for backward compatibility)\n */\nexport const init = async(inputId = null) => {\n    await loadStrings();\n\n    // Find the event selector container using data-region attribute\n    container = document.querySelector(Selectors.events.container);\n\n    if (container) {\n        // Find elements within container using data-* selectors\n        hiddenInput = container.querySelector(Selectors.events.hiddenInput);\n        counterEl = container.querySelector(Selectors.events.counter);\n\n        // Search input handler\n        const searchInput = container.querySelector(Selectors.events.searchInput);\n        if (searchInput) {\n            searchInput.addEventListener('keyup', (e) => {\n                filterEvents(e.target.value);\n            });\n        }\n\n        // Select/deselect visible buttons\n        const selectBtn = container.querySelector(Selectors.events.selectVisibleBtn);\n        if (selectBtn) {\n            selectBtn.addEventListener('click', selectVisible);\n        }\n\n        const deselectBtn = container.querySelector(Selectors.events.deselectVisibleBtn);\n        if (deselectBtn) {\n            deselectBtn.addEventListener('click', deselectVisible);\n        }\n\n        // Category collapse/expand\n        container.querySelectorAll(Selectors.events.categoryTitle).forEach((title) => {\n            title.style.cursor = 'pointer';\n            title.addEventListener('click', () => {\n                const events = title.nextElementSibling;\n                if (events) {\n                    events.style.display = events.style.display === 'none' ? 'block' : 'none';\n                }\n            });\n        });\n    } else if (inputId) {\n        // Fallback to legacy ID-based selectors\n        hiddenInput = document.getElementById(inputId);\n        counterEl = document.querySelector(Selectors.events.legacyCounter(inputId));\n\n        // Search input handler (legacy)\n        const searchInput = document.querySelector(Selectors.events.legacySearchInput(inputId));\n        if (searchInput) {\n            searchInput.addEventListener('keyup', (e) => {\n                filterEvents(e.target.value);\n            });\n        }\n\n        // Select/deselect visible buttons (legacy)\n        const selectBtn = document.querySelector(Selectors.events.legacySelectVisibleBtn(inputId));\n        if (selectBtn) {\n            selectBtn.addEventListener('click', selectVisible);\n        }\n\n        const deselectBtn = document.querySelector(Selectors.events.legacyDeselectVisibleBtn(inputId));\n        if (deselectBtn) {\n            deselectBtn.addEventListener('click', deselectVisible);\n        }\n\n        // Category collapse/expand (legacy)\n        document.querySelectorAll(Selectors.events.categoryTitle).forEach((title) => {\n            title.style.cursor = 'pointer';\n            title.addEventListener('click', () => {\n                const events = title.nextElementSibling;\n                if (events) {\n                    events.style.display = events.style.display === 'none' ? 'block' : 'none';\n                }\n            });\n        });\n    }\n\n    // Initial counter update\n    updateValue();\n\n    // Checkbox change handler (delegated to document for dynamic content)\n    document.addEventListener('change', (e) => {\n        // Check for both template and legacy checkbox selectors\n        if (e.target.matches(Selectors.events.checkbox) ||\n            e.target.matches(Selectors.events.legacyCheckbox)) {\n            updateValue();\n        }\n    });\n};\n"],"names":["syncedEvents","strings","container","hiddenInput","counterEl","loadStrings","async","results","key","component","selectedCount","allSynced","newEvents","removed","updateValue","selected","querySelectorAll","Selectors","events","checkbox","document","legacyCheckbox","forEach","cb","eventItem","closest","dataset","class","push","value","join","length","toAdd","filter","evt","includes","toRemove","innerHTML","replace","changes","textContent","filterEvents","term","lowerTerm","toLowerCase","item","classList","remove","hiddenClass","add","category","cat","selectVisible","selector","checked","deselectVisible","inputId","querySelector","counter","searchInput","addEventListener","e","target","selectBtn","selectVisibleBtn","deselectBtn","deselectVisibleBtn","categoryTitle","title","style","cursor","nextElementSibling","display","getElementById","legacyCounter","legacySearchInput","legacySelectVisibleBtn","legacyDeselectVisibleBtn","matches"],"mappings":"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"}