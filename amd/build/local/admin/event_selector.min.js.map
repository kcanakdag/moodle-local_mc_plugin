{"version":3,"file":"event_selector.min.js","sources":["../../../src/local/admin/event_selector.js"],"sourcesContent":["/**\n * Event selector module for the admin settings page.\n *\n * Handles event search, filtering, and bulk selection.\n * Uses data-* attributes from event_selector.mustache template.\n *\n * @module     local_mc_plugin/local/admin/event_selector\n * @copyright  2025 Kerem Can Akdag\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['local_mc_plugin/local/admin/selectors', 'core/str'], function(Selectors, Str) {\n    \"use strict\";\n\n    /** @type {Array} Currently synced events from MoodleConnect */\n    let syncedEvents = [];\n\n    /** @type {Object} Language strings */\n    let strings = {};\n\n    /** @type {HTMLElement|null} Event selector container */\n    let container = null;\n\n    /** @type {HTMLElement|null} Hidden input element */\n    let hiddenInput = null;\n\n    /** @type {HTMLElement|null} Counter element */\n    let counterEl = null;\n\n    /**\n     * Load language strings.\n     *\n     * @returns {Promise<void>}\n     */\n    const loadStrings = async() => {\n        const results = await Str.get_strings([\n            {key: 'event_selected_count', component: 'local_mc_plugin'},\n            {key: 'event_all_synced', component: 'local_mc_plugin'},\n            {key: 'event_new', component: 'local_mc_plugin'},\n            {key: 'event_removed', component: 'local_mc_plugin'},\n        ]);\n\n        strings = {\n            selectedCount: results[0],\n            allSynced: results[1],\n            newEvents: results[2],\n            removed: results[3],\n        };\n    };\n\n    /**\n     * Update the hidden input value with selected events.\n     */\n    const updateValue = () => {\n        if (!hiddenInput || !counterEl) {\n            return;\n        }\n\n        const selected = [];\n        // Use data-action selector for checkboxes from template\n        const checkboxes = container ?\n            container.querySelectorAll(`${Selectors.events.checkbox}:checked`) :\n            document.querySelectorAll(`${Selectors.events.checkbox}:checked, ${Selectors.events.legacyCheckbox}:checked`);\n\n        checkboxes.forEach((cb) => {\n            // Get class from parent mc-event-item's data-class attribute\n            const eventItem = cb.closest(Selectors.events.eventItem);\n            if (eventItem && eventItem.dataset.class) {\n                selected.push(eventItem.dataset.class);\n            }\n        });\n\n        hiddenInput.value = selected.join(',');\n\n        // Update counter with sync status\n        if (syncedEvents.length > 0) {\n            const toAdd = selected.filter((evt) => !syncedEvents.includes(evt)).length;\n            const toRemove = syncedEvents.filter((evt) => !selected.includes(evt)).length;\n\n            if (toAdd === 0 && toRemove === 0) {\n                counterEl.innerHTML = strings.selectedCount.replace('{$a}', selected.length) +\n                    ` <span class=\"text-success\">• ${strings.allSynced}</span>`;\n            } else {\n                const changes = [];\n                if (toAdd > 0) {\n                    changes.push(`${toAdd} ${strings.newEvents}`);\n                }\n                if (toRemove > 0) {\n                    changes.push(`${toRemove} ${strings.removed}`);\n                }\n                counterEl.innerHTML = strings.selectedCount.replace('{$a}', selected.length) +\n                    ` <span class=\"text-warning\">• ${changes.join(', ')}</span>`;\n            }\n        } else {\n            counterEl.textContent = strings.selectedCount.replace('{$a}', selected.length);\n        }\n    };\n\n\n    /**\n     * Filter events based on search term.\n     *\n     * @param {string} term Search term\n     */\n    const filterEvents = (term) => {\n        const lowerTerm = term.toLowerCase();\n        const eventItems = container ?\n            container.querySelectorAll(Selectors.events.eventItem) :\n            document.querySelectorAll(Selectors.events.eventItem);\n\n        eventItems.forEach((item) => {\n            const text = item.textContent.toLowerCase();\n            if (text.includes(lowerTerm)) {\n                item.classList.remove(Selectors.events.hiddenClass);\n            } else {\n                item.classList.add(Selectors.events.hiddenClass);\n            }\n        });\n\n        // Hide empty categories\n        const categories = container ?\n            container.querySelectorAll(Selectors.events.category) :\n            document.querySelectorAll(Selectors.events.category);\n\n        categories.forEach((cat) => {\n            const visible = cat.querySelectorAll(`${Selectors.events.eventItem}:not(.${Selectors.events.hiddenClass})`).length;\n            if (visible === 0) {\n                cat.classList.add(Selectors.events.hiddenClass);\n            } else {\n                cat.classList.remove(Selectors.events.hiddenClass);\n            }\n        });\n    };\n\n    /**\n     * Select all visible checkboxes.\n     */\n    const selectVisible = () => {\n        const selector = `${Selectors.events.eventItem}:not(.${Selectors.events.hiddenClass}) ${Selectors.events.checkbox}`;\n        const checkboxes = container ?\n            container.querySelectorAll(selector) :\n            document.querySelectorAll(selector);\n\n        checkboxes.forEach((cb) => {\n            cb.checked = true;\n        });\n        updateValue();\n    };\n\n    /**\n     * Deselect all visible checkboxes.\n     */\n    const deselectVisible = () => {\n        const selector = `${Selectors.events.eventItem}:not(.${Selectors.events.hiddenClass}) ${Selectors.events.checkbox}`;\n        const checkboxes = container ?\n            container.querySelectorAll(selector) :\n            document.querySelectorAll(selector);\n\n        checkboxes.forEach((cb) => {\n            cb.checked = false;\n        });\n        updateValue();\n    };\n\n    return {\n        /**\n         * Set the synced events array.\n         *\n         * @param {Array} events Array of synced event class names\n         */\n        setSyncedEvents: function(events) {\n            syncedEvents = events || [];\n        },\n\n        /**\n         * Trigger a counter update (called from other modules).\n         *\n         * @param {string} [inputId] The input element ID (for backward compatibility, ignored)\n         */\n        refreshCounter: function(inputId) { // eslint-disable-line no-unused-vars\n            updateValue();\n        },\n\n        /**\n         * Initialize the event selector.\n         *\n         * @param {string} [inputId] The hidden input element ID (for backward compatibility)\n         */\n        init: async function(inputId) {\n            inputId = inputId || null;\n            await loadStrings();\n\n            // Find the event selector container using data-region attribute\n            container = document.querySelector(Selectors.events.container);\n\n            if (container) {\n                // Find elements within container using data-* selectors\n                hiddenInput = container.querySelector(Selectors.events.hiddenInput);\n                counterEl = container.querySelector(Selectors.events.counter);\n\n                // Search input handler\n                const searchInput = container.querySelector(Selectors.events.searchInput);\n                if (searchInput) {\n                    searchInput.addEventListener('keyup', (e) => {\n                        filterEvents(e.target.value);\n                    });\n                }\n\n                // Select/deselect visible buttons\n                const selectBtn = container.querySelector(Selectors.events.selectVisibleBtn);\n                if (selectBtn) {\n                    selectBtn.addEventListener('click', selectVisible);\n                }\n\n                const deselectBtn = container.querySelector(Selectors.events.deselectVisibleBtn);\n                if (deselectBtn) {\n                    deselectBtn.addEventListener('click', deselectVisible);\n                }\n\n                // Category collapse/expand\n                container.querySelectorAll(Selectors.events.categoryTitle).forEach((title) => {\n                    title.style.cursor = 'pointer';\n                    title.addEventListener('click', () => {\n                        const events = title.nextElementSibling;\n                        if (events) {\n                            events.style.display = events.style.display === 'none' ? 'block' : 'none';\n                        }\n                    });\n                });\n            } else if (inputId) {\n                // Fallback to legacy ID-based selectors\n                hiddenInput = document.getElementById(inputId);\n                counterEl = document.querySelector(Selectors.events.legacyCounter(inputId));\n\n                // Search input handler (legacy)\n                const searchInput = document.querySelector(Selectors.events.legacySearchInput(inputId));\n                if (searchInput) {\n                    searchInput.addEventListener('keyup', (e) => {\n                        filterEvents(e.target.value);\n                    });\n                }\n\n                // Select/deselect visible buttons (legacy)\n                const selectBtn = document.querySelector(Selectors.events.legacySelectVisibleBtn(inputId));\n                if (selectBtn) {\n                    selectBtn.addEventListener('click', selectVisible);\n                }\n\n                const deselectBtn = document.querySelector(Selectors.events.legacyDeselectVisibleBtn(inputId));\n                if (deselectBtn) {\n                    deselectBtn.addEventListener('click', deselectVisible);\n                }\n\n                // Category collapse/expand (legacy)\n                document.querySelectorAll(Selectors.events.categoryTitle).forEach((title) => {\n                    title.style.cursor = 'pointer';\n                    title.addEventListener('click', () => {\n                        const events = title.nextElementSibling;\n                        if (events) {\n                            events.style.display = events.style.display === 'none' ? 'block' : 'none';\n                        }\n                    });\n                });\n            }\n\n            // Initial counter update\n            updateValue();\n\n            // Checkbox change handler (delegated to document for dynamic content)\n            document.addEventListener('change', (e) => {\n                // Check for both template and legacy checkbox selectors\n                if (e.target.matches(Selectors.events.checkbox) ||\n                    e.target.matches(Selectors.events.legacyCheckbox)) {\n                    updateValue();\n                }\n            });\n        }\n    };\n});\n"],"names":["define","Selectors","Str","syncedEvents","strings","container","hiddenInput","counterEl","updateValue","selected","querySelectorAll","events","checkbox","document","legacyCheckbox","forEach","cb","eventItem","closest","dataset","class","push","value","join","length","toAdd","filter","evt","includes","toRemove","innerHTML","selectedCount","replace","allSynced","changes","newEvents","removed","textContent","filterEvents","term","lowerTerm","toLowerCase","item","classList","remove","hiddenClass","add","category","cat","selectVisible","selector","checked","deselectVisible","setSyncedEvents","refreshCounter","inputId","init","async","results","get_strings","key","component","loadStrings","querySelector","counter","searchInput","addEventListener","e","target","selectBtn","selectVisibleBtn","deselectBtn","deselectVisibleBtn","categoryTitle","title","style","cursor","nextElementSibling","display","getElementById","legacyCounter","legacySearchInput","legacySelectVisibleBtn","legacyDeselectVisibleBtn","matches"],"mappings":"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"}